<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pedidos Bonitos ✨</title>

    <link rel="icon" href="/favicon.png" type="image/png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Nunito+Sans:wght@400;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Flatpickr CSS for Date Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    
    <!-- Flatpickr JS for Date Picker -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>


    <style>
        /* --- Base & Variables (Light Mode) --- */
        :root {
            --font-heading: 'Poppins', sans-serif;
            --font-body: 'Nunito Sans', sans-serif;
            --color-bg: #FFFBF5;
            --color-container-bg: #FFFFFF;
            --color-text: #5D5C61;
            --color-text-light: #7e7c82;
            --color-primary: #E07A5F;
            --color-secondary: #81B29A;
            --color-accent: #F2CC8F;
            --color-border: #EAE6E1;
            --color-shadow: rgba(93, 92, 97, 0.1);
            --color-danger: #dc3545; /* Color for delete actions */
            --color-danger-hover: #c82333;
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 15px;
            --color-row-selected-bg: #fdebd0; /* Light orange for selected row */
            --color-row-selected-text: #5D5C61;
            --color-search-highlight-current: #FCD34D; /* Amarillo más intenso para el actual */
        }

        /* --- Dark Mode Variables --- */
        body.dark-mode {
            --color-bg: #2c3e50;
            --color-container-bg: #34495e;
            --color-text: #ecf0f1;
            --color-text-light: #bdc3c7;
            --color-primary: #e74c3c;
            --color-secondary: #2ecc71;
            --color-accent: #f1c40f;
            --color-border: #3b5b7d;
            --color-shadow: rgba(0, 0, 0, 0.3);
            --color-danger: #e74c3c;
            --color-danger-hover: #c0392b;
            --color-row-selected-bg: #52504a; /* Darker orange/brown for selected row in dark mode */
            --color-row-selected-text: #ecf0f1;
            --color-search-highlight-current: #f59e0b;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--color-bg);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
            font-size: 16px;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.modal-open {
            overflow: hidden;
        }

        * { box-sizing: border-box; }
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            color: var(--color-text);
            margin-top: 0; margin-bottom: 0.75em; font-weight: 600;
        }
        a { color: var(--color-primary); text-decoration: none; transition: color 0.2s ease; }
        a:hover { color: #c96850; }
        body.dark-mode a:hover { color: #c0392b; }

        /* --- Estilos Pantalla de Carga --- */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg); /* Respetar el tema */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-box {
            text-align: center;
        }

        .loading-logo {
            animation: glowing-cyan 2.5s ease-in-out infinite;
            width: 80px;
            height: 80px;
            border-radius: 50%;
        }

        @keyframes glowing-cyan {
            0% { box-shadow: 0 0 5px rgba(0, 255, 255, 0.5); }
            50% { box-shadow: 0 0 50px 25px rgba(0, 255, 255, 0.8); }
            100% { box-shadow: 0 0 5px rgba(0, 255, 255, 0.5); }
        }

        #seccionLogin, #seccionPedidos {
            display: none;
        }
        
        .main-container {
            width: 100%;
            max-width: 95%;
            margin: 0 auto;
        }
        
        #seccionLogin.visible { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            width: 100%; 
            padding: 50px 20px; 
        }

        .login-container { background-color: var(--color-container-bg); padding: 40px; border-radius: var(--border-radius-lg); box-shadow: 0 5px 25px var(--color-shadow); text-align: center; max-width: 420px; width: 100%; }
        .login-container h1 { margin-bottom: 25px; font-size: 1.8em; color: var(--color-primary); }

        input[type="email"], input[type="password"], input[type="text"], input[type="tel"],
        input[type="url"], input[type="number"], input[type="file"], textarea, select {
            width: 100%; padding: 12px 15px; margin-bottom: 18px; border: 1px solid var(--color-border);
            border-radius: var(--border-radius-md); font-family: var(--font-body); font-size: 1rem;
            color: var(--color-text); background-color: var(--color-container-bg);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(129, 178, 154, 0.2); }
        body.dark-mode input:focus, body.dark-mode textarea:focus, body.dark-mode select:focus { box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3); }

        textarea { min-height: 80px; resize: vertical; }
        label { display: block; margin-bottom: 6px; text-align: left; font-weight: 600; font-size: 0.9em; color: var(--color-text-light); }

        /* --- Photo Upload Styling --- */
        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            display: inline-block;
            background-color: var(--color-secondary);
            color: white;
            padding: 10px 20px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-family: var(--font-heading);
            font-weight: 600;
            font-size: 1rem;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .custom-file-upload:hover {
            background-color: #6aa88d;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
         body.dark-mode .custom-file-upload:hover { background-color: #27ae60; }


        .custom-file-upload:active {
            transform: translateY(0px);
            box-shadow: none;
        }

        .file-input-container {
            border: 2px dashed var(--color-border);
            border-radius: var(--border-radius-md);
            padding: 15px;
            margin-bottom: 18px;
            transition: all 0.3s ease;
            outline: none;
        }
        .file-input-container:focus-within {
            border-color: var(--color-secondary);
            box-shadow: 0 0 0 3px rgba(129, 178, 154, 0.2);
        }

        .file-input-container.drag-over {
            border-color: var(--color-secondary);
            background-color: rgba(129, 178, 154, 0.1);
        }
        body.dark-mode .file-input-container.drag-over {
             background-color: rgba(46, 204, 113, 0.2);
        }

        .file-input-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .previews-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 50px;
        }
        .preview-thumbnail {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            border: 2px solid transparent;
            background-color: var(--color-bg);
            cursor: grab;
            transition: border-color 0.2s ease, opacity 0.2s ease;
        }
        .preview-thumbnail.dragging {
            opacity: 0.4;
            cursor: grabbing;
        }
        .preview-thumbnail.selected {
            border-color: var(--color-primary);
            box-shadow: 0 0 8px var(--color-primary);
        }

        .preview-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-thumbnail::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 0;
            height: 100%;
            width: 4px;
            background-color: var(--color-primary);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            pointer-events: none;
        }
        .preview-thumbnail.drag-over-placeholder::before {
            opacity: 1;
        }


        .preview-thumbnail .delete-photo-btn {
            position: absolute;
            background-color: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.8em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            z-index: 2;
            top: 5px;
            right: 5px;
        }
        .preview-thumbnail .delete-photo-btn:hover {
            background-color: var(--color-danger);
             transform: scale(1.1);
        }
        
        /* NEW STYLE FOR CHECKBOX */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            margin-top: -5px; /* Adjust spacing */
        }
        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin-bottom: 0;
            flex-shrink: 0;
        }
        .checkbox-container label {
            margin-bottom: 0;
            font-weight: normal;
            font-size: 0.9em;
            color: var(--color-text-light);
            cursor: pointer;
        }
        
        button {
            font-family: var(--font-heading); font-weight: 600; padding: 12px 25px; border: none;
            border-radius: var(--border-radius-md); cursor: pointer; font-size: 1rem; margin-top: 10px;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease, color 0.2s ease;
            display: inline-flex; align-items: center; gap: 8px;
        }
        button:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        button:active { transform: translateY(0px); box-shadow: none; }

        button[type="submit"], #btnGuardarPedido { background-color: var(--color-primary); color: white; }
        button[type="submit"]:hover, #btnGuardarPedido:hover { background-color: #c96850; }
        body.dark-mode button[type="submit"]:hover, body.dark-mode #btnGuardarPedido:hover { background-color: #c0392b; }


        #btnCancelarPedido, #btnBorrarFiltros, #btnCerrarSesion, .modal-confirm-cancel, #btnCerrarModalConfirmacionRegistro, #btnCerrarModalComentarioBottom { background-color: #f0f0f0; color: var(--color-text-light); }
        #btnCancelarPedido:hover, #btnBorrarFiltros:hover, #btnCerrarSesion:hover, .modal-confirm-cancel:hover, #btnCerrarModalConfirmacionRegistro:hover, #btnCerrarModalComentarioBottom:hover { background-color: #e0e0e0; color: var(--color-text); }
         body.dark-mode #btnCancelarPedido, body.dark-mode #btnBorrarFiltros, body.dark-mode #btnCerrarSesion, body.dark-mode .modal-confirm-cancel, body.dark-mode #btnCerrarModalConfirmacionRegistro, body.dark-mode #btnCerrarModalComentarioBottom { background-color: #4a6572; color: var(--color-text-light); }
         body.dark-mode #btnCancelarPedido:hover, body.dark-mode #btnBorrarFiltros:hover, body.dark-mode #btnCerrarSesion:hover, body.dark-mode .modal-confirm-cancel:hover, body.dark-mode #btnCerrarModalConfirmacionRegistro:hover, body.dark-mode #btnCerrarModalComentarioBottom:hover { background-color: #34495e; color: var(--color-text); }


        #btnMostrarFormularioPedido {
             background: linear-gradient(135deg, var(--color-primary), #f4a261); color: white; font-size: 1.1em;
             padding: 14px 30px; border-radius: var(--border-radius-lg); margin-bottom: 30px;
             box-shadow: 0 4px 15px rgba(224, 122, 95, 0.3);
        }
        #btnMostrarFormularioPedido:hover { box-shadow: 0 6px 20px rgba(224, 122, 95, 0.4); transform: translateY(-2px); }
        body.dark-mode #btnMostrarFormularioPedido { background: linear-gradient(135deg, var(--color-primary), #e67e22); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
        body.dark-mode #btnMostrarFormularioPedido:hover { box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4); }


        #btnCerrarSesion { margin: 40px auto 10px auto; display: block; width: fit-content; }

        #mensajeError, #mensajeErrorPedido, #mensajeConfirmacion, #copy-toast {
             margin-top: 15px; color: #d9534f; font-weight: 600; min-height: 1.2em; text-align: center; font-size: 0.9em;
             background-color: rgba(217, 83, 79, 0.1); border-radius: var(--border-radius-sm); padding: 8px; display: block;
        }
         body.dark-mode #mensajeError, body.dark-mode #mensajeErrorPedido, body.dark-mode #mensajeConfirmacion { background-color: rgba(231, 76, 60, 0.2); color: #e74c3c; }

        #mensajeError:empty, #mensajeErrorPedido:empty, #mensajeConfirmacion:empty { display: none; }
        #mensajeConfirmacion.success, #copy-toast { background-color: rgba(40, 167, 69, 0.1); color: #155724; border-color: #c3e6cb; }
        body.dark-mode #mensajeConfirmacion.success, body.dark-mode #copy-toast { background-color: rgba(46, 204, 113, 0.2); color: #2ecc71; border-color: #27ae60;}
        #mensajeConfirmacion.error, #copy-toast.error { background-color: rgba(217, 83, 79, 0.1); color: #721c24; border-color: #f5c6cb;}
        body.dark-mode #mensajeConfirmacion.error, body.dark-mode #copy-toast.error { background-color: rgba(231, 76, 60, 0.2); color: #e74c3c; border-color: #c0392b;}

        #copy-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            border-radius: var(--border-radius-md);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-weight: 600;
        }
        #copy-toast.show {
            opacity: 1;
            visibility: visible;
        }
        
        #photo-copy-toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10001;
            transform: translateY(20px);
            background: linear-gradient(135deg, var(--color-primary), #f4a261);
            color: white;
            padding: 10px 20px;
            border-radius: var(--border-radius-md);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-family: var(--font-heading);
            font-weight: 600;
            font-size: 0.95em;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }

        #photo-copy-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        body.dark-mode #photo-copy-toast {
            background: linear-gradient(135deg, var(--color-primary), #e67e22);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        #seccionPedidos.visible { 
            display: block; 
            width: 100%; 
            background-color: transparent; 
            padding: 0; 
            box-shadow: none; 
            margin: 20px auto; 
        }

        .titulo-contador-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        #seccionPedidos > .titulo-contador-container > h1 {
            text-align: left;
            color: var(--color-primary);
            margin-bottom: 0;
            font-size: 2em;
            font-weight: 700;
            border: none;
            padding-bottom: 0;
        }

        .contador-pedidos {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 5px 12px;
            border-radius: var(--border-radius-lg);
            font-size: 0.9em;
            font-weight: 700;
            font-family: var(--font-heading);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        body.dark-mode .contador-pedidos {
            background-color: var(--color-primary);
            color: white;
        }

        #contadorPedidosFiltrados {
            background-color: var(--color-secondary);
            color: white;
            cursor: pointer;
            display: none; /* Hidden by default */
        }
        body.dark-mode #contadorPedidosFiltrados {
            background-color: #27ae60;
        }
        #contadorPedidosFiltrados.visible {
            display: inline-block;
        }

        /* NEW: Styles for the filtered sum counter */
        #contadorSumaFiltrada {
            background-color: var(--color-primary);
            color: white;
            display: none; /* Hidden by default */
        }
        body.dark-mode #contadorSumaFiltrada {
            background-color: #c0392b;
        }
        #contadorSumaFiltrada.visible {
            display: inline-block;
        }


        #usuarioLogueado { text-align: right; color: var(--color-text-light); font-size: 0.95em; margin-bottom: 25px; }

        .content-box { background-color: var(--color-container-bg); padding: 25px 30px; border-radius: var(--border-radius-lg); box-shadow: 0 4px 20px var(--color-shadow); margin-bottom: 30px; transition: background-color 0.3s ease, box-shadow 0.3s ease; }

        #filtrosContainer h2 { font-size: 1.3em; color: var(--color-secondary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px 20px; align-items: end; }
        #filtrosContainer label { font-weight: 600; font-size: 0.85em; color: var(--color-text); margin-bottom: 4px; display: flex; align-items: center; gap: 5px; }
        
        #rangoFechaPersonalizado {
            display: none; /* Hidden by default */
            grid-column: span 2;
            margin-top: 10px;
        }
        #rangoFechaPersonalizado input {
            cursor: pointer;
        }


        #btnAplicarFiltros {
            background-color: var(--color-primary);
            color: white;
            padding: 10px 20px;
            font-size: 0.9em;
            justify-self: start;
            margin-top: 10px;
        }
         #btnAplicarFiltros:hover {
             background-color: #c96850;
         }
         body.dark-mode #btnAplicarFiltros:hover { background-color: #c0392b; }


        #btnBorrarFiltros { padding: 10px 20px; font-size: 0.9em; justify-self: start; margin-top: 10px; }

        .modal-overlay {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(40, 40, 40, 0.7);
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
         body.dark-mode .modal-overlay { background-color: rgba(0, 0, 0, 0.8); }


        .modal-content {
            background-color: var(--color-container-bg); margin: auto;
            padding: 30px 40px; border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25); position: relative;
            width: 100%; max-width: 750px; max-height: 90vh; overflow-y: auto;
            transition: border-color 0.2s ease, background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
        }

        .modal-content-image {
            background-color: var(--color-container-bg);
            margin: auto;
            padding: 25px;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
            position: relative;
            width: auto;
            max-width: 80vw;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .modal-close-btn {
            position: absolute; top: 10px; right: 15px; background: transparent;
            border: none; font-size: 2.5rem; font-weight: 300;
            color: var(--color-text-light); cursor: pointer; line-height: 1;
            padding: 0 5px; margin: 0; transition: color 0.2s ease;
        }
        .modal-close-btn:hover { color: var(--color-primary); transform: none; box-shadow: none; }

        .modal-image-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-image-nav-btn {
            background: var(--color-accent);
            color: var(--color-text);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            flex-shrink: 0;
        }
        .modal-image-nav-btn:hover {
            background-color: #e0b86b;
        }
        .modal-image-nav-btn:disabled {
            background-color: var(--color-border);
            cursor: not-allowed;
            opacity: 0.6;
        }
        body.dark-mode .modal-image-nav-btn:hover { background-color: #d39e00; }
        body.dark-mode .modal-image-nav-btn:disabled { background-color: #4a6572; }
        
        #modalImagenPedidoCounter {
            font-family: var(--font-heading);
            font-weight: 600;
        }

        .modal-image-order-id {
            font-family: var(--font-heading);
            font-size: 1.4em;
            font-weight: 700;
            color: white;
            background-color: var(--color-primary);
            padding: 8px 15px;
            border-radius: var(--border-radius-md);
            margin-bottom: 20px;
            text-align: center;
            display: inline-block;
            cursor: default;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-image {
            display: block;
            max-width: 100%;
            max-height: calc(80vh - 260px); 
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: var(--border-radius-md);
        }
        
        .modal-thumbnail-container {
            width: 100%;
            margin-top: 15px;
            padding: 5px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            background-color: var(--color-bg);
            border-radius: var(--border-radius-md);
        }
        
        .modal-thumbnail-item {
            width: 60px;
            height: 60px;
            object-fit: contain; /* Changed from cover to contain */
            background-color: var(--color-border); /* Added background for letterboxing */
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s ease, transform 0.2s ease;
            flex-shrink: 0;
        }

        .modal-thumbnail-item:hover {
            transform: scale(1.05);
            border-color: var(--color-accent);
        }

        .modal-thumbnail-item.active {
            border-color: var(--color-primary);
            box-shadow: 0 0 5px var(--color-primary);
        }

         #nuevoPedidoContainer h2 { text-align: center; font-size: 1.5em; color: var(--color-secondary); margin-bottom: 25px; }
         #formularioNuevoPedido .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px 25px; margin-bottom: 25px; }
         .form-item-full { grid-column: 1 / -1; }
         #formularioNuevoPedido .form-actions { text-align: right; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--color-border); }
         #formularioNuevoPedido button { margin-left: 12px; }

        .tabla-container-wrapper {
            position: relative;
        }
        .tabla-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 60vh;
        }
        #tablaPedidos {
            width: 100%; min-width: 1100px;
            border-collapse: separate; border-spacing: 0;
            font-size: 0.9em; border-radius: var(--border-radius-md); overflow: hidden;
        }
        #tablaPedidos th, #tablaPedidos td { padding: 12px 15px; border-bottom: 1px solid var(--color-border); text-align: left; vertical-align: middle; white-space: nowrap; transition: background-color 0.3s ease, color 0.3s ease; }

        #tablaPedidos td.comment-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        #tablaPedidos thead th {
            background-color: var(--color-secondary); color: white; font-weight: 600; font-family: var(--font-heading);
            position: sticky;
            top: 0;
            z-index: 1;
            border-bottom: 2px solid #6aa88d;
            transition: background-color 0.3s ease, color 0.3s ease, border-bottom-color 0.3s ease;
        }
         body.dark-mode #tablaPedidos thead th { border-bottom-color: #27ae60; }

        #tablaPedidos th:first-child, #tablaPedidos td:first-child { border-left: none; }
        #tablaPedidos th:last-child, #tablaPedidos td:last-child { border-right: none; }
        #tablaPedidos tbody tr { transition: background-color 0.15s ease, opacity 0.3s ease; }
        #tablaPedidos tbody tr:last-child td { border-bottom: none; }
        #tablaPedidos tbody tr:nth-child(even) { background-color: #f8fafa; }
        body.dark-mode #tablaPedidos tbody tr:nth-child(even) { background-color: #3b5b7d; }

        #tablaPedidos tbody tr:hover { background-color: rgba(242, 204, 143, 0.2); }
        body.dark-mode #tablaPedidos tbody tr:hover { background-color: rgba(241, 196, 15, 0.3); }

        #tablaPedidos tbody tr.selected-row {
            background-color: var(--color-row-selected-bg) !important;
            color: var(--color-row-selected-text);
        }
        #tablaPedidos tbody tr.selected-row td {
            color: var(--color-row-selected-text);
        }


        #tablaPedidos .loading-cell, #tablaPedidos .empty-cell {
            text-align: center !important; padding: 30px 15px !important; font-style: italic; color: var(--color-text-light);
            background-color: var(--color-container-bg) !important;
        }

        #tablaPedidos .loading-cell .fa-spinner { margin-right: 8px; color: var(--color-secondary); }

        .datos-container { /* Replaces .datos-producto-container & .datos-promocion-container */
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: normal;
        }
        .datos-container .img-container {
            position: relative;
            flex-shrink: 0;
        }

        .datos-container img {
             width: 45px; height: 45px; border-radius: var(--border-radius-sm);
             display: inline-block; vertical-align: middle;
             border: 1px solid var(--color-border); object-fit: cover;
             cursor: pointer;
             flex-shrink: 0;
        }
        .datos-container .photo-count-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: var(--color-primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid white;
        }
        .datos-container .foto-placeholder {
            font-style: italic; color: var(--color-text-light); font-size: 0.9em;
            display: inline-block; width: 45px; height: 45px; line-height: 45px;
            text-align: center; border: 1px dashed var(--color-border);
            border-radius: var(--border-radius-sm); background-color: var(--color-bg);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            flex-shrink: 0;
        }
        .datos-text { /* Replaces .datos-producto-text & .datos-promocion-text */
            flex-grow: 1;
        }

        .status-display {
            padding: 5px 10px;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            display: inline-block;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            border: 1px solid transparent;
        }
        .status-display:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .status-pagado { background-color: #d4edda; color: #155724; border-color: #c3e6cb;}
        .status-foto-enviada { background-color: #cce5ff; color: #004085; border-color: #b8daff;}
        .status-cancelado { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;}
        .status-esperando-pago { background-color: #fff3cd; color: #856404; border-color: #ffeeba;}
        .status-corregir { background-color: #ffecb3; color: #664d03; border-color: #ffe082;}
        .status-corregido { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc; }
        .status-mns-amenazador { background-color: #f5c6cb; color: #721c24; border-color: #e0a8b0;}
        .status-fabricar { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb;}
        .status-diseñado { background-color: #e2d9f3; color: #4b0082; border-color: #d1c4e9;}
        .status-sin-estatus { background-color: #e9ecef; color: #495057; border-color: #ced4da;}
        .status-default { background-color: #f0f0f0; color: var(--color-text-light); border-color: #e0e0e0; }

        body.dark-mode .status-pagado { background-color: #2ecc71; color: #145a32; border-color: #27ae60;}
        body.dark-mode .status-foto-enviada { background-color: #3498db; color: #1a5276; border-color: #2980b9;}
        body.dark-mode .status-cancelado { background-color: #e74c3c; color: #641e16; border-color: #c0392b;}
        body.dark-mode .status-esperando-pago { background-color: #f1c40f; color: #7e5109; border-color: #d68910;}
        body.dark-mode .status-corregir { background-color: #e67e22; color: #6e2c00; border-color: #d35400;}
        body.dark-mode .status-corregido { background-color: #20c997; color: #084235; border-color: #198754; }
        body.dark-mode .status-mns-amenazador { background-color: #9b59b6; color: #4a235a; border-color: #8e44ad;}
        body.dark-mode .status-fabricar { background-color: #1abc9c; color: #0e6655; border-color: #16a085;}
        body.dark-mode .status-diseñado { background-color: #7e57c2; color: #ede7f6; border-color: #5e35b1;}
        body.dark-mode .status-sin-estatus { background-color: #7f8c8d; color: #2c3e50; border-color: #95a5a6;}


        .circular-menu-container {
            position: fixed;
            z-index: 1050;
            width: 240px;
            height: 280px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .circular-menu-info-bar {
            width: 90%;
            max-width: 200px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 0.9em;
            font-weight: 600;
            color: white;
            background-color: var(--color-text-light);
            border-radius: var(--border-radius-sm);
            margin-bottom: 10px;
            pointer-events: auto;
            transition: background-color 0.2s ease, color 0.2s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
         body.dark-mode .circular-menu-info-bar { background-color: #bdc3c7; color: #34495e; }


        .circular-menu {
            position: relative;
            width: 100%;
            height: 240px;
            pointer-events: auto;
        }
        .menu-item {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 48px;
            height: 48px;
            margin-top: -24px;
            margin-left: -24px;
            background-color: var(--color-container-bg);
            color: var(--color-text);
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            border: 1px solid var(--color-border);
        }
        .menu-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .menu-item i {
            font-size: 1.5em;
            line-height: 1;
        }
        .menu-item span {
            display: none;
        }
        .menu-item.active-status {
            border-width: 2.5px;
            box-shadow: 0 0 0 2px var(--color-container-bg), 0 0 0 4px currentColor;
        }

        .action-button {
            padding: 5px 10px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            margin-left: 5px;
            border: none;
        }
        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .action-button:active {
            transform: translateY(0px);
            box-shadow: none;
        }

        .edit-button {
            background-color: #ffc107;
            color: #343a40;
        }
        .edit-button:hover { background-color: #e0a800; }
        body.dark-mode .edit-button { background-color: var(--color-accent); color: var(--color-text); }
        body.dark-mode .edit-button:hover { background-color: #d39e00; }

        .delete-button {
            background-color: var(--color-danger);
            color: white;
        }
        .delete-button:hover { background-color: var(--color-danger-hover); }
        body.dark-mode .delete-button { background-color: var(--color-danger); }
        body.dark-mode .delete-button:hover { background-color: var(--color-danger-hover); }


        #darkModeToggle {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 8px 15px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease, color 0.2s ease;
            margin-left: 20px;
        }
        #darkModeToggle:hover {
            background-color: #e0b86b;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
         body.dark-mode #darkModeToggle { background-color: #556270; color: white; }
         body.dark-mode #darkModeToggle:hover { background-color: #4a545d; }


        .user-info-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 25px;
        }
        #pedidoProductoOtro {
            margin-top: 8px;
        }

        /* Confirmation Modal Styles */
        .modal-confirm-content, #modalConfirmacionRegistro .modal-content {
            background-color: var(--color-container-bg);
            margin: auto;
            padding: 30px 40px;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            position: relative;
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        .modal-confirm-content h3, #modalConfirmacionRegistro .modal-content h3 {
            font-size: 1.3em;
            color: var(--color-text);
            margin-bottom: 15px;
        }
        #modalConfirmacionRegistro .modal-content h3 {
             color: var(--color-secondary); /* Green title for success */
        }
        .modal-confirm-content p {
            font-size: 1em;
            color: var(--color-text-light);
            margin-bottom: 25px;
            line-height: 1.5;
        }
        .modal-confirm-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .modal-confirm-delete {
            background-color: var(--color-danger);
            color: white;
        }
        .modal-confirm-delete:hover {
            background-color: var(--color-danger-hover);
        }

        /* Styles for the copy phone button */
        .copy-phone-button {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 4px 8px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.8em;
            border: none;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .copy-phone-button:hover {
            background-color: #e0b86b;
        }
        body.dark-mode .copy-phone-button:hover {
            background-color: #d39e00;
        }
        .copy-phone-button.copied {
            background-color: var(--color-secondary);
            color: white !important;
        }
        body.dark-mode .copy-phone-button.copied {
            background-color: #27ae60;
        }
        .copy-phone-button i {
            pointer-events: none;
        }

        /* --- Custom Checkbox for Phone --- */
        .phone-actions-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
        }

        .phone-checkbox-container {
            position: relative;
            cursor: pointer;
            font-size: 22px;
            user-select: none;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phone-checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .phone-checkbox-container .checkmark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            height: 20px;
            width: 20px;
            background-color: #eee;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        body.dark-mode .phone-checkbox-container .checkmark {
            background-color: #4a6572;
            border-color: #7f8c8d;
        }

        .phone-checkbox-container:hover input ~ .checkmark {
            background-color: #ccc;
        }
        body.dark-mode .phone-checkbox-container:hover input ~ .checkmark {
            background-color: #556270;
        }

        .phone-checkbox-container input:checked ~ .checkmark {
            background-color: var(--color-secondary);
        }

        .phone-checkbox-container .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .phone-checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }

        .phone-checkbox-container .checkmark:after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        /* --- Custom Checkbox for Estatus (NEW) --- */
        .status-actions-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
        }

        .status-checkbox-container {
            position: relative;
            cursor: pointer;
            font-size: 22px;
            user-select: none;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .status-checkbox-container .checkmark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            height: 20px;
            width: 20px;
            background-color: #eee;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        body.dark-mode .status-checkbox-container .checkmark {
            background-color: #4a6572;
            border-color: #7f8c8d;
        }

        .status-checkbox-container:hover input ~ .checkmark {
            background-color: #ccc;
        }
        body.dark-mode .status-checkbox-container:hover input ~ .checkmark {
            background-color: #556270;
        }

        .status-checkbox-container input:checked ~ .checkmark {
            background-color: #D9006C; /* Magenta color */
            border-color: #D9006C;
        }

        .status-checkbox-container .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .status-checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }

        .status-checkbox-container .checkmark:after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }


        /* Styles for new order confirmation modal */
        #numeroPedidoConfirmacion {
            font-size: 2.5em; /* Large font for order number */
            font-weight: 700;
            color: var(--color-primary);
            margin: 15px 0;
            display: inline-block; /* To allow button next to it */
        }
        #btnCopiarNumeroPedidoConfirmacion {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 6px 10px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            border: none;
            transition: background-color 0.2s ease, color 0.2s ease;
            vertical-align: middle;
        }
        #btnCopiarNumeroPedidoConfirmacion:hover {
            background-color: #e0b86b;
        }
        body.dark-mode #btnCopiarNumeroPedidoConfirmacion:hover {
             background-color: #d39e00;
        }
        #btnCopiarNumeroPedidoConfirmacion.copied {
            background-color: var(--color-secondary);
            color: white !important;
        }
         body.dark-mode #btnCopiarNumeroPedidoConfirmacion.copied {
            background-color: #27ae60;
        }
        #modalConfirmacionRegistro .modal-content .modal-close-btn {
             top: 15px; /* Adjust if needed */
             right: 20px;
        }
        #modalConfirmacionRegistro .modal-content .form-actions {
            text-align: center; /* Center the close button */
            margin-top: 25px;
            padding-top: 0;
            border-top: none;
        }

        /* --- Estilos para la Búsqueda (Ctrl+F) --- */
        #page-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999; /* Debajo de los elementos de búsqueda y la tabla */
            display: none;
            transition: opacity 0.3s ease;
        }
        body.search-active #page-overlay {
            display: block;
        }

        #search-bar-container {
            position: fixed;
            top: 25px;
            right: 25px;
            z-index: 1001; /* Encima de todo */
            background-color: var(--color-container-bg);
            padding: 8px 12px;
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            display: none; /* Oculto por defecto, se muestra con JS */
            align-items: center;
            gap: 10px;
        }
        
        #search-match-icon {
            display: none; /* Hidden by default */
            font-size: 1.1em; /* Adjusted size */
            width: 24px; /* fixed width */
            text-align: center;
            font-weight: 600;
        }
        
        #searchInput {
            width: 220px;
            margin-bottom: 0;
            border: none;
        }
        #searchInput:focus {
            box-shadow: none;
            border: none;
        }
        #search-counter {
            font-size: 0.9em;
            color: var(--color-text-light);
            padding: 0 10px;
            border-right: 1px solid var(--color-border);
        }
        #search-nav-buttons button {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin: 0 2px;
            color: var(--color-text-light);
        }
        #search-nav-buttons button:hover {
            color: var(--color-primary);
            background-color: rgba(0,0,0,0.05);
            box-shadow: none;
            transform: none;
        }
        #search-nav-buttons button:disabled {
            cursor: not-allowed;
            opacity: 0.4;
        }

        #closeSearchBtn {
            margin: 0;
            background: transparent;
            border: none;
            font-size: 1.8rem;
            color: var(--color-text-light);
            cursor: pointer;
            line-height: 1;
            padding: 0 0 0 10px;
            border-left: 1px solid var(--color-border);
        }
        #closeSearchBtn:hover {
            color: var(--color-primary);
            transform: none;
            box-shadow: none;
            background: transparent;
        }

        /* Durante la búsqueda, levanta la tabla sobre el overlay */
        body.search-active .tabla-container-wrapper {
            position: relative;
            z-index: 1000;
        }

        /* Resalta las filas que coinciden */
        #tablaPedidos tbody tr.search-match {
           /* No background color, just override opacity */
           opacity: 1 !important;
        }
        #tablaPedidos tbody tr.current-search-highlight {
            background-color: var(--color-search-highlight-current) !important;
            box-shadow: 0 0 0 2px var(--color-primary);
        }

        body.dark-mode #tablaPedidos tbody tr.current-search-highlight {
            color: #111;
        }

        /* MODIFIED: Highlight for specific matched text */
        mark.search-highlight-text {
            background-color: #96ceb4; /* Verde de la imagen */
            padding: 2px 1px;
            border-radius: var(--border-radius-sm);
            box-shadow: 0 0 5px #96ceb4;
            font-weight: 600;
        }

        /* MODIFIED: Highlight for specific matched text in dark mode */
        body.dark-mode mark.search-highlight-text {
            background-color: #a7ddc1; /* Verde más claro para modo oscuro */
            box-shadow: 0 0 5px #a7ddc1;
        }

        /* Las filas que no coinciden se opacan */
        body.search-active #tablaPedidos tbody tr:not(.search-match) {
           opacity: 0.3;
           pointer-events: none; /* Evitar clics en filas no coincidentes */
        }

        /* Botón para subir */
        #scrollToTopBtn {
            display: none;
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 10;
            width: 45px;
            height: 45px;
            padding: 0;
            border-radius: 50%;
            background-color: var(--color-primary);
            color: white;
            font-size: 1.2em;
            line-height: 45px;
            text-align: center;
        }
        #scrollToTopBtn:hover {
            background-color: #c96850;
        }
        body.dark-mode #scrollToTopBtn:hover {
            background-color: #c0392b;
        }

        /* NEW: Modal for Full Comment */
        #modalComentario {
            z-index: 1001; /* Ensure it's above search overlay */
        }
        #modalComentario .modal-content {
            max-width: 500px;
        }
        #textoComentarioCompleto {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 60vh;
            overflow-y: auto;
            background-color: var(--color-bg);
            padding: 15px;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--color-border);
            line-height: 1.7;
            font-size: 1.05em;
        }
        #modalComentario .form-actions {
            text-align: center;
            border-top: none;
            padding-top: 15px;
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="loading-box">
        <img src="/favicon.png" class="loading-logo" alt="Cargando...">
    </div>
</div>

<div class="main-container">

    <div id="seccionLogin">
         <div class="login-container">
            <h1><i class="fas fa-gift"></i> Iniciar Sesión</h1>
            <form id="formularioLogin">
                <div>
                    <label for="email">Correo Electrónico:</label>
                    <input type="email" id="email" required placeholder="tu.correo@ejemplo.com">
                </div>
                <div>
                    <label for="password">Contraseña:</label>
                    <input type="password" id="password" required placeholder="••••••••">
                </div>
                 <div id="mensajeError"></div>
                <button type="submit"><i class="fas fa-sign-in-alt"></i> Ingresar</button>
            </form>
        </div>
    </div>

    <div id="seccionPedidos">
        <div class="titulo-contador-container">
            <h1><i class="fas fa-list-alt" style="color: var(--color-secondary);"></i> Lista de Pedidos</h1>
            <span id="contadorPedidosHoy" class="contador-pedidos" title="Pedidos registrados hoy">0</span>
            <span id="contadorPedidosFiltrados" class="contador-pedidos" title="Pedidos en la vista actual (clic 5 veces para ver suma)"></span>
            <span id="contadorSumaFiltrada" class="contador-pedidos" title="Suma de precios de los pedidos filtrados"></span>
        </div>
        <div class="user-info-container">
             <p id="usuarioLogueado"></p>
             <button id="darkModeToggle"><i class="fas fa-moon"></i> Modo Oscuro</button>
        </div>


        <div id="filtrosContainer" class="content-box">
             <h2><i class="fas fa-filter"></i> Filtros</h2>
             <div class="filtros-grid">
                 <div class="filtro-item">
                    <label for="filtroProducto"><i class="fas fa-tag"></i> Por producto:</label>
                    <select id="filtroProducto">
                        <option value="">Todos los productos</option>
                    </select>
                 </div>
                  <div class="filtro-item">
                     <label for="filtroFecha"><i class="fas fa-calendar-day"></i> Por fecha:</label>
                     <select id="filtroFecha">
                         <option value="">Cualquier fecha</option>
                         <option value="ultimos-10-dias">Últimos 10 días</option>
                         <option value="hoy">Hoy</option>
                         <option value="ayer">Ayer</option>
                         <option value="este-mes">Este mes</option>
                         <option value="personalizado">Personalizado</option>
                     </select>
                  </div>
                  <div class="filtro-item">
                    <label for="filtroEstatus"><i class="fas fa-check-circle"></i> Por estatus:</label>
                    <select id="filtroEstatus">
                        <option value="">Todos los estatus</option>
                        </select>
                 </div>
                 <div id="rangoFechaPersonalizado" class="filtro-item">
                    <label for="filtroFechaPersonalizada"><i class="fas fa-calendar-alt"></i> Fecha o Rango:</label>
                    <input type="text" id="filtroFechaPersonalizada" placeholder="Selecciona una fecha o un rango">
                 </div>

                 <div class="filtro-item" style="grid-column: span 2; display: flex; gap: 10px;">
                    <button id="btnAplicarFiltros"><i class="fas fa-filter"></i> Aplicar Filtros</button>
                    <button id="btnBorrarFiltros"><i class="fas fa-eraser"></i> Borrar Filtros</button>
                 </div>

             </div>
        </div>

        <button id="btnMostrarFormularioPedido"><i class="fas fa-plus-circle"></i> Registrar Nuevo Pedido</button>
        <div id="mensajeConfirmacion"></div>
        <div class="tabla-container-wrapper content-box">
              <div class="tabla-container">
                  <table id="tablaPedidos">
                      <thead>
                          <tr>
                              <th># Pedido</th>
                              <th>Fecha y Hora</th>
                              <th>Vendedor</th>
                              <th>Teléfono</th>
                              <th>Estatus</th>
                              <th>Comentarios</th>
                              <th>Producto</th>
                              <th>Datos Producto</th>
                              <th>Promoción</th>
                              <th>Precio</th>
                              <th>Acciones</th>
                          </tr>
                      </thead>
                      <tbody id="cuerpoTablaPedidos">
                          <tr>
                              <td colspan="11" class="loading-cell"><i class="fas fa-spinner fa-spin"></i> Cargando pedidos lindos...</td>
                          </tr>
                      </tbody>
                  </table>
              </div>
              <button id="scrollToTopBtn" title="Ir arriba"><i class="fas fa-arrow-up"></i></button>
         </div>

        <button id="btnCerrarSesion"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
    </div>

</div>

<div id="modalNuevoPedido" class="modal-overlay" style="display: none;">
    <div class="modal-content" id="modalContentNuevoPedido">
        <button id="btnCerrarModal" class="modal-close-btn" title="Cerrar">×</button>
        <div id="nuevoPedidoContainer">
             <h2 id="modalTitle"><i class="fas fa-pencil-alt"></i> Registrar Nuevo Pedido</h2>
             <form id="formularioNuevoPedido">
                 <div class="form-grid">
                     <div class="form-item">
                         <label for="pedidoProductoSelect">Producto (*):</label>
                         <select id="pedidoProductoSelect" required>
                            <option value="Modelo 7">Modelo 7</option>
                            <option value="Portallaves">Portallaves</option>
                            <option value="Calendario">Calendario</option>
                            <option value="Placa de perro">Placa de perro</option>
                            <option value="Otro">Otro</option>
                         </select>
                         <input type="text" id="pedidoProductoOtro" style="display: none;" placeholder="Nombre del producto">
                     </div>
                     <div class="form-item">
                         <label for="pedidoTelefono">Teléfono (*):</label>
                         <input type="tel" id="pedidoTelefono" placeholder="Ej: 5512345678" required>
                     </div>
                     <div class="form-item">
                          <label for="pedidoPrecio">Precio (MXN):</label>
                          <input type="number" id="pedidoPrecio" step="0.01" placeholder="Ej: 275.00">
                      </div>

                      <div class="form-item form-item-full">
                           <label for="pedidoFotoFile">Fotos del Pedido (Clic derecho o Ctrl+C para copiar):</label>
                           <div class="file-input-container" id="fileInputContainerProducto" tabindex="0">
                               <input type="file" id="pedidoFotoFile" accept="image/*" multiple>
                               <div class="file-input-header">
                                   <label for="pedidoFotoFile" class="custom-file-upload">
                                       <i class="fas fa-upload"></i> Seleccionar
                                   </label>
                                   <span>O arrastra y suelta imágenes aquí</span>
                               </div>
                               <div class="previews-container" id="fotosPreviewContainer">
                                   </div>
                           </div>
                      </div>
                     <div class="form-item form-item-full">
                         <label for="pedidoDatosProducto">Detalles del Producto:</label>
                         <textarea id="pedidoDatosProducto" placeholder="Describe los detalles específicos del producto solicitado..."></textarea>
                     </div>

                     <div class="form-item form-item-full">
                        <label for="pedidoFotoPromocionFile">Fotos de la Promoción (Clic derecho o Ctrl+C para copiar):</label>
                        
                        <!-- NEW CHECKBOX CONTAINER -->
                        <div class="checkbox-container" id="mismaFotoContainer" style="display: none;">
                            <input type="checkbox" id="mismaFotoCheckbox">
                            <label for="mismaFotoCheckbox">Usar la(s) misma(s) foto(s) del pedido</label>
                        </div>
                        
                        <div class="file-input-container" id="fileInputContainerPromocion" tabindex="0">
                            <input type="file" id="pedidoFotoPromocionFile" accept="image/*" multiple>
                            <div class="file-input-header">
                                <label for="pedidoFotoPromocionFile" class="custom-file-upload">
                                    <i class="fas fa-upload"></i> Seleccionar
                                </label>
                                <span>O arrastra y suelta imágenes aquí</span>
                            </div>
                            <div class="previews-container" id="promoFotosPreviewContainer">
                                </div>
                        </div>
                    </div>
                    <div class="form-item form-item-full">
                        <label for="pedidoDatosPromocion">Detalles de la Promoción:</label>
                        <textarea id="pedidoDatosPromocion" placeholder="Describe la promoción aplicada, si existe..."></textarea>
                    </div>

                    <div class="form-item form-item-full">
                           <label for="pedidoComentarios">Comentarios Adicionales:</label>
                           <textarea id="pedidoComentarios" placeholder="Añade cualquier otra nota relevante sobre el pedido..."></textarea>
                    </div>
                 </div>
                 <div id="mensajeErrorPedido"></div>
                 <div class="form-actions">
                      <button type="button" id="btnCancelarPedido"><i class="fas fa-times"></i> Cancelar</button>
                      <button type="submit" id="btnGuardarPedido"><i class="fas fa-save"></i> Guardar Pedido</button>
                 </div>
             </form>
        </div>
    </div>
</div>

<div id="modalImagenPedido" class="modal-overlay" style="display: none;">
    <div class="modal-content-image">
        <button id="btnCerrarModalImagen" class="modal-close-btn" title="Cerrar">×</button>
        <div id="modalImagenPedidoId" class="modal-image-order-id"></div>
        <div class="modal-image-header">
            <button id="modalImagenPrevBtn" class="modal-image-nav-btn" title="Anterior"><i class="fas fa-chevron-left"></i></button>
            <span id="modalImagenPedidoCounter">1 / 1</span>
            <button id="modalImagenNextBtn" class="modal-image-nav-btn" title="Siguiente"><i class="fas fa-chevron-right"></i></button>
        </div>
        <img id="imagenModal" class="modal-image" src="" alt="Foto del Pedido">
        <div id="modalThumbnailContainer" class="modal-thumbnail-container"></div>
    </div>
</div>

<div id="modalConfirmarBorrado" class="modal-overlay" style="display: none;">
    <div class="modal-confirm-content">
        <button id="btnCerrarModalConfirmarBorrado" class="modal-close-btn" title="Cerrar">×</button>
        <h3><i class="fas fa-exclamation-triangle" style="color: var(--color-danger);"></i> Confirmar Borrado</h3>
        <p id="textoConfirmarBorrado">¿Estás seguro de que quieres borrar este pedido? Esta acción no se puede deshacer.</p>
        <div id="mensajeErrorConfirmacion"></div>
        <div class="modal-confirm-actions">
            <button type="button" id="btnCancelarBorrado" class="modal-confirm-cancel"><i class="fas fa-times"></i> Cancelar</button>
            <button type="button" id="btnConfirmarBorradoDefinitivo" class="modal-confirm-delete"><i class="fas fa-trash-alt"></i> Sí, Borrar</button>
        </div>
    </div>
</div>

<div id="modalConfirmacionRegistro" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3><i class="fas fa-check-circle"></i> Pedido Registrado Correctamente</h3>
        <div>
            <span id="numeroPedidoConfirmacion"></span>
            <button id="btnCopiarNumeroPedidoConfirmacion" title="Copiar número de pedido"><i class="fas fa-copy"></i></button>
        </div>
        <div class="form-actions">
            <button type="button" id="btnCerrarModalConfirmacionRegistro"><i class="fas fa-times"></i> Cerrar</button>
        </div>
    </div>
</div>

<div id="modalComentario" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <button id="btnCerrarModalComentarioTop" class="modal-close-btn" title="Cerrar">×</button>
        <h3><i class="fas fa-comment-dots" style="color: var(--color-secondary);"></i> Comentario Completo</h3>
        <p id="textoComentarioCompleto"></p>
         <div class="form-actions">
            <button type="button" id="btnCerrarModalComentarioBottom" class="modal-confirm-cancel"><i class="fas fa-times"></i> Cerrar</button>
        </div>
    </div>
</div>

<div id="copy-toast">¡Texto copiado!</div>
<div id="photo-copy-toast">¡Foto copiada!</div>

<div id="page-overlay"></div>
<div id="search-bar-container" style="display: none;">
    <span id="search-match-icon"></span>
    <input type="text" id="searchInput" placeholder="Buscar en pedidos...">
    <span id="search-counter">0/0</span>
    <div id="search-nav-buttons">
        <button id="prevMatchBtn" title="Anterior (Shift+Enter)"><i class="fas fa-chevron-up"></i></button>
        <button id="nextMatchBtn" title="Siguiente (Enter)"><i class="fas fa-chevron-down"></i></button>
    </div>
    <button id="closeSearchBtn" title="Cerrar (Esc)">&times;</button>
</div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, doc, updateDoc, where, getDocs, runTransaction, getDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    document.addEventListener('DOMContentLoaded', () => {

        const startTime = Date.now(); 

        const firebaseConfig = {
            apiKey: "AIzaSyBdLBxVl64KqifVUinLrtxjQnk2jrPT-yg", // Replace with your actual Firebase config
            authDomain: "pedidos-con-gemini.firebaseapp.com",
            projectId: "pedidos-con-gemini",
            storageBucket: "pedidos-con-gemini.firebasestorage.app", // Correct storage bucket
            messagingSenderId: "300825194175",
            appId: "1:300825194175:web:972fa7b8af195a83e6e00a",
            measurementId: "G-FTCDCMZB1S"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const seccionLogin = document.getElementById('seccionLogin');
        const seccionPedidos = document.getElementById('seccionPedidos');
        const usuarioLogueado = document.getElementById('usuarioLogueado');
        const formularioLogin = document.getElementById('formularioLogin');
        const inputEmail = document.getElementById('email');
        const inputPassword = document.getElementById('password');
        const mensajeErrorLogin = document.getElementById('mensajeError');
        const cuerpoTablaPedidos = document.getElementById('cuerpoTablaPedidos');
        const btnCerrarSesion = document.getElementById('btnCerrarSesion');
        const btnMostrarFormularioPedido = document.getElementById('btnMostrarFormularioPedido');
        const modalNuevoPedido = document.getElementById('modalNuevoPedido');
        const btnCerrarModal = document.getElementById('btnCerrarModal');
        const formularioNuevoPedido = document.getElementById('formularioNuevoPedido');
        const btnCancelarPedido = document.getElementById('btnCancelarPedido');
        const btnGuardarPedido = document.getElementById('btnGuardarPedido');
        const mensajeErrorPedido = document.getElementById('mensajeErrorPedido');
        const modalTitle = document.getElementById('modalTitle');
        const contadorPedidosHoy = document.getElementById('contadorPedidosHoy');
        const contadorPedidosFiltrados = document.getElementById('contadorPedidosFiltrados');
        const contadorSumaFiltrada = document.getElementById('contadorSumaFiltrada');
        const mensajeConfirmacionGeneral = document.getElementById('mensajeConfirmacion');
        const tablaPedidos = document.getElementById('tablaPedidos');
        const tablaContainer = document.querySelector('.tabla-container');
        const scrollToTopBtn = document.getElementById('scrollToTopBtn');
        const copyToast = document.getElementById('copy-toast');
        const photoCopyToast = document.getElementById('photo-copy-toast');


        // Form inputs for pedido
        const pedidoProductoSelect = document.getElementById('pedidoProductoSelect');
        const pedidoProductoOtroInput = document.getElementById('pedidoProductoOtro');
        const pedidoTelefonoInput = document.getElementById('pedidoTelefono');
        const pedidoPrecioInput = document.getElementById('pedidoPrecio');
        const pedidoComentariosInput = document.getElementById('pedidoComentarios');
        const pedidoDatosProductoInput = document.getElementById('pedidoDatosProducto');
        const pedidoDatosPromocionInput = document.getElementById('pedidoDatosPromocion');

        // Product Photo elements
        const fileInputContainerProducto = document.getElementById('fileInputContainerProducto');
        const pedidoFotoFileInput = document.getElementById('pedidoFotoFile');
        const fotosPreviewContainer = document.getElementById('fotosPreviewContainer');
        
        // Promotion Photo elements
        const fileInputContainerPromocion = document.getElementById('fileInputContainerPromocion');
        const pedidoFotoPromocionFileInput = document.getElementById('pedidoFotoPromocionFile');
        const promoFotosPreviewContainer = document.getElementById('promoFotosPreviewContainer');

        // "Same Photo" Checkbox Elements
        const mismaFotoContainer = document.getElementById('mismaFotoContainer');
        const mismaFotoCheckbox = document.getElementById('mismaFotoCheckbox');

        // Image modal elements
        const modalImagenPedido = document.getElementById('modalImagenPedido');
        const btnCerrarModalImagen = document.getElementById('btnCerrarModalImagen');
        const imagenModal = document.getElementById('imagenModal');
        const modalImagenPedidoId = document.getElementById('modalImagenPedidoId');
        const modalImagenPrevBtn = document.getElementById('modalImagenPrevBtn');
        const modalImagenNextBtn = document.getElementById('modalImagenNextBtn');
        const modalImagenPedidoCounter = document.getElementById('modalImagenPedidoCounter');
        const modalThumbnailContainer = document.getElementById('modalThumbnailContainer');

        // Filter elements
        const filtroProductoSelect = document.getElementById('filtroProducto');
        const filtroFechaSelect = document.getElementById('filtroFecha');
        const filtroEstatusSelect = document.getElementById('filtroEstatus');
        const btnAplicarFiltros = document.getElementById('btnAplicarFiltros');
        const btnBorrarFiltros = document.getElementById('btnBorrarFiltros');
        const rangoFechaPersonalizadoContainer = document.getElementById('rangoFechaPersonalizado');
        const filtroFechaPersonalizadaInput = document.getElementById('filtroFechaPersonalizada');


        // Dark Mode Toggle elements
        const darkModeToggle = document.getElementById('darkModeToggle');

        // Confirmation Modal for Deletion elements
        const modalConfirmarBorrado = document.getElementById('modalConfirmarBorrado');
        const btnCerrarModalConfirmarBorrado = document.getElementById('btnCerrarModalConfirmarBorrado');
        const textoConfirmarBorrado = document.getElementById('textoConfirmarBorrado');
        const btnCancelarBorrado = document.getElementById('btnCancelarBorrado');
        const btnConfirmarBorradoDefinitivo = document.getElementById('btnConfirmarBorradoDefinitivo');
        const mensajeErrorConfirmacion = document.getElementById('mensajeErrorConfirmacion');

        // New Order Registration Confirmation Modal Elements
        const modalConfirmacionRegistro = document.getElementById('modalConfirmacionRegistro');
        const numeroPedidoConfirmacionSpan = document.getElementById('numeroPedidoConfirmacion');
        const btnCopiarNumeroPedidoConfirmacion = document.getElementById('btnCopiarNumeroPedidoConfirmacion');
        const btnCerrarModalConfirmacionRegistro = document.getElementById('btnCerrarModalConfirmacionRegistro');

        // Full Comment Modal Elements
        const modalComentario = document.getElementById('modalComentario');
        const textoComentarioCompleto = document.getElementById('textoComentarioCompleto');
        const btnCerrarModalComentarioTop = document.getElementById('btnCerrarModalComentarioTop');
        const btnCerrarModalComentarioBottom = document.getElementById('btnCerrarModalComentarioBottom');

        // Search Bar Elements
        const searchBarContainer = document.getElementById('search-bar-container');
        const searchInput = document.getElementById('searchInput');
        const searchMatchIcon = document.getElementById('search-match-icon');
        const closeSearchBtn = document.getElementById('closeSearchBtn');
        const pageOverlay = document.getElementById('page-overlay');
        const searchCounter = document.getElementById('search-counter');
        const prevMatchBtn = document.getElementById('prevMatchBtn');
        const nextMatchBtn = document.getElementById('nextMatchBtn');


        // --- State Management & Firebase Refs ---
        const pedidosCollectionRef = collection(db, "pedidos");
        const orderCounterRef = doc(db, "counters", "orders");

        let unsubscribePedidos = null;
        let unsubscribeHoy = null;
        let activeCircularMenu = null;
        let editingPedidoId = null;
        let pedidoParaBorrarId = null;
        let pedidoParaBorrarData = null;
        let loggedInUserName = '';
        let currentlySelectedRow = null;
        let selectedRowId = null; 
        let searchMatches = [];
        let currentSearchIndex = -1;
        let selectedThumbnail = { element: null, manager: null, index: -1 };
        let datePickerInstance = null;
        let filteredCounterClicks = 0;
        let lastFilteredCounterClickTime = 0;

        // State for multiple order photos
        let orderPhotosManager = [];
        let initialOrderPhotoUrls = []; 

        // State for multiple promotion photos
        let promoPhotosManager = [];
        let initialPromoPhotoUrls = [];
        
        // State for image modal viewer
        let modalImageViewer = {
            urls: [],
            currentIndex: 0,
            orderId: ''
        };

        const statusOptions = [
            { value: "Sin estatus", text: "Sin Estatus", icon: "fas fa-question-circle", color: "#6c757d" },
            { value: "Foto enviada", text: "Foto Enviada", icon: "fas fa-camera-retro", color: "#007bff" },
            { value: "Esperando pago", text: "Esperando Pago", icon: "fas fa-hourglass-half", color: "#ffc107" },
            { value: "Pagado", text: "Pagado", icon: "fas fa-check-circle", color: "#28a745" },
            { value: "Diseñado", text: "Diseñado", icon: "fas fa-palette", color: "#6f42c1" },
            { value: "Fabricar", text: "Fabricar", icon: "fas fa-cogs", color: "#17a2b8" },
            { value: "Corregir", text: "Corregir", icon: "fas fa-edit", color: "#fd7e14" },
            { value: "Corregido", text: "Corregido", icon: "fas fa-check-double", color: "#20c997" },
            { value: "Mns Amenazador", text: "Mns Amenazador", icon: "fas fa-skull-crossbones", color: "#dc3545" },
            { value: "Cancelado", text: "Cancelado", icon: "fas fa-times-circle", color: "#6c757d" }
        ];

        // --- All Function Definitions ---
        
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                if (darkModeToggle) darkModeToggle.innerHTML = '<i class="fas fa-sun"></i> Modo Claro';
            } else {
                document.body.classList.remove('dark-mode');
                 if (darkModeToggle) darkModeToggle.innerHTML = '<i class="fas fa-moon"></i> Modo Oscuro';
            }
        }
        
        function formatFirebaseTimestamp(timestamp) {
             if (!timestamp || typeof timestamp.toDate !== 'function') return 'Fecha inválida';
             try {
                 return timestamp.toDate().toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
             } catch (e) { return 'Fecha inválida'; }
        }
        function formatCurrency(value) {
            const number = Number(value);
            if (isNaN(number)) return '-';
            return number.toLocaleString('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2 });
        }

        function preloadImage(src) {
            const img = new Image();
            img.src = src;
        }

        function preloadAllImagesInBackground(pedidos) {
            let imagesToPreloadCount = 0;
            pedidos.forEach(pedido => {
                if (pedido.fotoUrls && pedido.fotoUrls.length > 1) {
                    for (let i = 1; i < pedido.fotoUrls.length; i++) {
                        preloadImage(pedido.fotoUrls[i]);
                        imagesToPreloadCount++;
                    }
                }
                if (pedido.fotoPromocionUrls && pedido.fotoPromocionUrls.length > 1) {
                    for (let i = 1; i < pedido.fotoPromocionUrls.length; i++) {
                        preloadImage(pedido.fotoPromocionUrls[i]);
                        imagesToPreloadCount++;
                    }
                }
            });
            if (imagesToPreloadCount > 0) {
                console.log(`Pre-cargando ${imagesToPreloadCount} imágenes adicionales en segundo plano...`);
            }
        }

        function arePhotoArraysIdentical(arr1, arr2) {
            if (arr1.length !== arr2.length) return false;
            const getSignature = (p) => p.isNew ? p.file.name + p.file.size : p.url;
            const signatures1 = arr1.map(getSignature).sort();
            const signatures2 = arr2.map(getSignature).sort();
            return signatures1.every((val, index) => val === signatures2[index]);
        }

        function createPhotoPreviewRenderer(previewContainer, photoManager, onUpdateCallback) {
            let draggedItem = null;

            const renderPreviews = () => {
                previewContainer.innerHTML = '';
                
                photoManager.forEach((photo, index) => {
                    const thumb = document.createElement('div');
                    thumb.className = 'preview-thumbnail';
                    
                    thumb.dataset.index = index;
                    thumb.draggable = true;
                    
                    thumb.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (selectedThumbnail.element && selectedThumbnail.element !== thumb) {
                            selectedThumbnail.element.classList.remove('selected');
                        }
                        
                        if (thumb.classList.contains('selected')) {
                            thumb.classList.remove('selected');
                            selectedThumbnail = { element: null, manager: null, index: -1 };
                        } else {
                            thumb.classList.add('selected');
                            selectedThumbnail = { element: thumb, manager: photoManager, index };
                        }
                    });

                    thumb.addEventListener('dragstart', e => {
                        draggedItem = thumb;
                        e.dataTransfer.setData('draggedIndex', index);
                        e.dataTransfer.setData('sourceContainerId', previewContainer.id);
                        setTimeout(() => thumb.classList.add('dragging'), 0);
                    });

                    thumb.addEventListener('dragend', () => {
                        if (draggedItem) {
                            draggedItem.classList.remove('dragging');
                        }
                        draggedItem = null;
                    });

                    const img = document.createElement('img');
                    img.src = photo.isNew ? URL.createObjectURL(photo.file) : photo.url;
                    if (photo.isNew) {
                        img.onload = () => URL.revokeObjectURL(img.src);
                    }
                    
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-photo-btn';
                    delBtn.innerHTML = '&times;';
                    delBtn.title = 'Eliminar esta foto';
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (thumb.classList.contains('selected')) {
                            selectedThumbnail = { element: null, manager: null, index: -1 };
                        }
                        photoManager.splice(index, 1);
                        renderPreviews(); 
                    };

                    thumb.appendChild(img);
                    thumb.appendChild(delBtn);
                    previewContainer.appendChild(thumb);
                });

                if (onUpdateCallback) {
                    onUpdateCallback(photoManager, previewContainer);
                }
            };

            previewContainer.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(previewContainer, e.clientX);
                previewContainer.querySelectorAll('.preview-thumbnail').forEach(t => t.classList.remove('drag-over-placeholder'));
                const sourceContainerId = e.dataTransfer.getData('sourceContainerId');
                if (sourceContainerId) {
                     if(document.querySelector('.dragging')){
                         if (afterElement) {
                            afterElement.classList.add('drag-over-placeholder');
                         }
                     }
                }
            });
            
             previewContainer.addEventListener('dragleave', e => {
                 if (!previewContainer.contains(e.relatedTarget)) {
                    previewContainer.querySelectorAll('.preview-thumbnail').forEach(t => t.classList.remove('drag-over-placeholder'));
                 }
            });

            previewContainer.addEventListener('drop', e => {
                e.preventDefault();
                e.stopPropagation();
                previewContainer.querySelectorAll('.preview-thumbnail').forEach(t => t.classList.remove('drag-over-placeholder'));

                const sourceContainerId = e.dataTransfer.getData('sourceContainerId');
                const draggedIndex = e.dataTransfer.getData('draggedIndex');

                if (sourceContainerId && draggedIndex !== null) {
                    if (sourceContainerId === previewContainer.id) {
                        const oldIndex = parseInt(draggedIndex);
                        const afterElement = getDragAfterElement(previewContainer, e.clientX);
                        let newIndex;

                        if (afterElement == null) {
                            newIndex = photoManager.length;
                        } else {
                            newIndex = parseInt(afterElement.dataset.index);
                        }

                        const [movedItem] = photoManager.splice(oldIndex, 1);
                        photoManager.splice(newIndex > oldIndex ? newIndex - 1 : newIndex, 0, movedItem);
                        
                    } else {
                        const sourceManager = (sourceContainerId === fotosPreviewContainer.id) ? orderPhotosManager : promoPhotosManager;
                        const photoToCopy = sourceManager[draggedIndex];

                        if (photoToCopy) {
                            const newPhoto = { ...p, isNew: true, file: p.file };
                            photoManager.push(newPhoto);
                        }
                    }
                    renderPreviews();
                }
            });
            
            function getDragAfterElement(container, x) {
                const draggableElements = [...container.querySelectorAll('.preview-thumbnail:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = x - box.left - box.width / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            return renderPreviews;
        }
        
        const onOrderPhotosUpdate = (manager) => {
            if (!mismaFotoContainer || !mismaFotoCheckbox) return;

            if (manager.length > 0) {
                mismaFotoContainer.style.display = 'flex';
            } else {
                mismaFotoContainer.style.display = 'none';
                if (mismaFotoCheckbox.checked) {
                    mismaFotoCheckbox.checked = false;
                    promoPhotosManager.length = 0;
                    renderPromoPhotoPreviews();
                }
            }

            if (mismaFotoCheckbox.checked) {
                promoPhotosManager.length = 0;
                const newPromoPhotos = manager.map(p => ({ ...p, isNew: true, file: p.file }));
                promoPhotosManager.push(...newPromoPhotos);
                renderPromoPhotoPreviews();
            }
        };
        
        const onPromoPhotosUpdate = (manager) => {
             if (mismaFotoCheckbox.checked && !arePhotoArraysIdentical(orderPhotosManager, promoPhotosManager)) {
                mismaFotoCheckbox.checked = false;
            }
        };

        const renderOrderPhotoPreviews = createPhotoPreviewRenderer(fotosPreviewContainer, orderPhotosManager, onOrderPhotosUpdate);
        const renderPromoPhotoPreviews = createPhotoPreviewRenderer(promoFotosPreviewContainer, promoPhotosManager, onPromoPhotosUpdate);


        function setupDragAndDrop(dropZoneElement, fileInputElement, managerArray, renderFunction) {
            if (!dropZoneElement || !fileInputElement) return;

            dropZoneElement.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZoneElement.classList.add('drag-over');
            });

            dropZoneElement.addEventListener('dragleave', (e) => {
                if (!dropZoneElement.contains(e.relatedTarget)) {
                    dropZoneElement.classList.remove('drag-over');
                }
            });

            dropZoneElement.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZoneElement.classList.remove('drag-over');

                const sourceContainerId = e.dataTransfer.getData('sourceContainerId');
                if (sourceContainerId) {
                    return; 
                }

                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    for (const file of e.dataTransfer.files) {
                         if (file.type.startsWith('image/')) {
                            managerArray.push({ file: file, url: null, isNew: true });
                         }
                    }
                    renderFunction();
                }
            });
            
             fileInputElement.addEventListener('change', (e) => {
                for (const file of e.target.files) {
                    managerArray.push({ file: file, url: null, isNew: true });
                }
                renderFunction();
                e.target.value = '';
            });
        }
        
        function setupPasteListener(pasteZone, manager, renderFunc) {
            pasteZone.addEventListener('paste', e => {
                e.preventDefault();
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                let imagesPasted = false;
                for (const item of items) {
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        manager.push({ file, url: null, isNew: true });
                        imagesPasted = true;
                    }
                }
                if (imagesPasted) {
                    renderFunc();
                }
            });
        }
        
        function abrirModalPedido(pedidoData = null) {
            if (!modalNuevoPedido || !formularioNuevoPedido || !modalTitle || !btnGuardarPedido || !pedidoPrecioInput) return;

            formularioNuevoPedido.reset();
            editingPedidoId = null;
            mensajeErrorPedido.textContent = '';
            
            orderPhotosManager.length = 0;
            initialOrderPhotoUrls.length = 0;
            promoPhotosManager.length = 0;
            initialPromoPhotoUrls.length = 0;
            selectedThumbnail = { element: null, manager: null, index: -1 };
            mismaFotoContainer.style.display = 'none';
            fileInputContainerPromocion.style.pointerEvents = 'auto';
            fileInputContainerPromocion.style.opacity = '1';
            
            pedidoProductoOtroInput.style.display = 'none';
            pedidoProductoOtroInput.required = false;

            if (pedidoData) { // EDIT MODE
                modalTitle.innerHTML = '<i class="fas fa-edit"></i> Editar Pedido';
                btnGuardarPedido.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
                editingPedidoId = pedidoData.id;

                const producto = pedidoData.producto || '';
                const esOpcionPredeterminada = Array.from(pedidoProductoSelect.options).some(opt => opt.value === producto);
                if (esOpcionPredeterminada) {
                    pedidoProductoSelect.value = producto;
                } else {
                    pedidoProductoSelect.value = 'Otro';
                    pedidoProductoOtroInput.value = producto;
                    pedidoProductoOtroInput.style.display = 'block';
                    pedidoProductoOtroInput.required = true;
                }

                pedidoTelefonoInput.value = pedidoData.telefono || '';
                pedidoPrecioInput.value = pedidoData.precio || '';
                pedidoComentariosInput.value = pedidoData.comentarios || '';
                pedidoDatosProductoInput.value = pedidoData.datosProducto || '';
                pedidoDatosPromocionInput.value = pedidoData.datosPromocion || '';

                const photoUrls = pedidoData.fotoUrls || (pedidoData.fotoUrl ? [pedidoData.fotoUrl] : []);
                initialOrderPhotoUrls.push(...photoUrls);
                photoUrls.forEach(url => orderPhotosManager.push({ file: null, url: url, isNew: false }));

                const promoUrls = pedidoData.fotoPromocionUrls || (pedidoData.fotoPromocionUrl ? [pedidoData.fotoPromocionUrl] : []);
                initialPromoPhotoUrls.push(...promoUrls);
                promoUrls.forEach(url => promoPhotosManager.push({ file: null, url: url, isNew: false }));

            } else { // NEW ORDER MODE
                modalTitle.innerHTML = '<i class="fas fa-pencil-alt"></i> Registrar Nuevo Pedido';
                btnGuardarPedido.innerHTML = '<i class="fas fa-save"></i> Guardar Pedido';
                pedidoPrecioInput.value = '275';
                pedidoProductoSelect.value = 'Modelo 7';
            }

            renderOrderPhotoPreviews();
            renderPromoPhotoPreviews();

            modalNuevoPedido.style.display = 'flex';
            document.body.classList.add('modal-open');
            pedidoProductoSelect.focus();
        }

        function cerrarModalPedido() {
            if (!modalNuevoPedido) return;
            modalNuevoPedido.style.display = 'none';
            document.body.classList.remove('modal-open');
            if(btnGuardarPedido) btnGuardarPedido.disabled = false;
            if(btnCancelarPedido) btnCancelarPedido.disabled = false;
            if(btnGuardarPedido) btnGuardarPedido.innerHTML = '<i class="fas fa-save"></i> Guardar Pedido';
            editingPedidoId = null;
        }

        function updateModalImageView() {
            const { urls, currentIndex, orderId } = modalImageViewer;
            if (!urls || urls.length === 0) {
                cerrarModalImagen();
                return;
            }
            
            imagenModal.src = urls[currentIndex];
            modalImagenPedidoId.textContent = orderId;
            modalImagenPedidoCounter.textContent = `${currentIndex + 1} / ${urls.length}`;
            modalImagenPrevBtn.disabled = currentIndex === 0;
            modalImagenNextBtn.disabled = currentIndex === urls.length - 1;

            document.querySelectorAll('.modal-thumbnail-item').forEach(thumb => thumb.classList.remove('active'));
            const activeThumb = document.querySelector(`.modal-thumbnail-item[data-index="${currentIndex}"]`);
            if(activeThumb) {
                activeThumb.classList.add('active');
                activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            if (currentIndex < urls.length - 1) preloadImage(urls[currentIndex + 1]);
            if (currentIndex > 0) preloadImage(urls[currentIndex - 1]);
        }

        function abrirModalImagen(imageUrls, startIndex, orderId) {
            if (!modalImagenPedido || !imageUrls || imageUrls.length === 0) return;
            
            modalImageViewer = {
                urls: imageUrls,
                currentIndex: startIndex,
                orderId: orderId
            };
            
            modalThumbnailContainer.innerHTML = '';
            imageUrls.forEach((url, index) => {
                const thumbImg = document.createElement('img');
                thumbImg.src = url;
                thumbImg.className = 'modal-thumbnail-item';
                thumbImg.dataset.index = index;
                thumbImg.addEventListener('click', () => {
                    modalImageViewer.currentIndex = index;
                    updateModalImageView();
                });
                modalThumbnailContainer.appendChild(thumbImg);
            });

            updateModalImageView();
            modalImagenPedido.style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function cerrarModalImagen() {
            if (!modalImagenPedido) return;
            modalImagenPedido.style.display = 'none';
            document.body.classList.remove('modal-open');
            imagenModal.src = '';
            modalThumbnailContainer.innerHTML = '';
            modalImageViewer = { urls: [], currentIndex: 0, orderId: '' };
        }
        
        function abrirModalConfirmarBorrado(pedidoId, pedidoData) {
            if (!modalConfirmarBorrado || !textoConfirmarBorrado || !mensajeErrorConfirmacion) return;
            pedidoParaBorrarId = pedidoId;
            pedidoParaBorrarData = pedidoData;
            textoConfirmarBorrado.innerHTML = `¿Estás seguro de que quieres borrar el pedido <strong>DH${pedidoData.consecutiveOrderNumber || pedidoId}</strong>? Esta acción no se puede deshacer.`;
            mensajeErrorConfirmacion.textContent = '';
            mensajeErrorConfirmacion.className = '';
            modalConfirmarBorrado.style.display = 'flex';
            document.body.classList.add('modal-open');
            if(btnConfirmarBorradoDefinitivo) btnConfirmarBorradoDefinitivo.disabled = false;
            if(btnCancelarBorrado) btnCancelarBorrado.disabled = false;
        }

        function cerrarModalConfirmarBorrado() {
            if (!modalConfirmarBorrado) return;
            modalConfirmarBorrado.style.display = 'none';
            document.body.classList.remove('modal-open');
            pedidoParaBorrarId = null;
            pedidoParaBorrarData = null;
            if(btnConfirmarBorradoDefinitivo) btnConfirmarBorradoDefinitivo.innerHTML = '<i class="fas fa-trash-alt"></i> Sí, Borrar';
        }

        function mostrarModalConfirmacionRegistro(numeroPedido) {
            if (!modalConfirmacionRegistro || !numeroPedidoConfirmacionSpan || !btnCopiarNumeroPedidoConfirmacion) return;

            numeroPedidoConfirmacionSpan.textContent = `DH${numeroPedido}`;
            btnCopiarNumeroPedidoConfirmacion.innerHTML = '<i class="fas fa-copy"></i>';
            btnCopiarNumeroPedidoConfirmacion.classList.remove('copied');

            modalConfirmacionRegistro.style.display = 'flex';
            document.body.classList.add('modal-open');

            if (typeof confetti === 'function') {
                const duration = 3 * 1000;
                const animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1001 };

                function randomInRange(min, max) { return Math.random() * (max - min) + min; }

                const interval = setInterval(function() {
                    const timeLeft = animationEnd - Date.now();
                    if (timeLeft <= 0) return clearInterval(interval);

                    const particleCount = 50 * (timeLeft / duration);
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
                }, 250);

                confetti({
                    particleCount: 150,
                    spread: 100,
                    origin: { y: 0.6 },
                    zIndex: 1001,
                    colors: ['#E07A5F', '#81B29A', '#F2CC8F', '#FFFBF5', '#5D5C61']
                });

            } else {
                console.warn("La librería confetti no está cargada.");
            }
        }

        function cerrarModalConfirmacionRegistro() {
            if (!modalConfirmacionRegistro) return;
            modalConfirmacionRegistro.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function abrirModalComentario(texto) {
            if(!modalComentario || !textoComentarioCompleto) return;
            textoComentarioCompleto.textContent = texto || 'No hay comentario.';
            modalComentario.style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function cerrarModalComentario() {
            if(!modalComentario) return;
            modalComentario.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function getDateRange(filter) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            let startDate = null, endDate = null;
            switch (filter) {
                case 'hoy':
                    startDate = today;
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() + 1);
                    break;
                case 'ayer':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 1);
                    endDate = today;
                    break;
                case 'este-mes':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    break;
                case 'ultimos-10-dias':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 9);
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() + 1);
                    break;
            }
            return { startDate, endDate };
        }
        
        function cargarPedidos(productoFilter = '', dateFilter = '', statusFilter = '', customStartDate = null, customEndDate = null) {
            if (!cuerpoTablaPedidos) return;
            if (unsubscribePedidos) unsubscribePedidos();

            cuerpoTablaPedidos.innerHTML = `<tr><td colspan="11" class="loading-cell"><i class="fas fa-spinner fa-spin"></i> Cargando pedidos lindos...</td></tr>`;
            
            let q = query(pedidosCollectionRef, orderBy("createdAt", "desc"));
            if (productoFilter) q = query(q, where("producto", "==", productoFilter));
            if (statusFilter) q = query(q, where("estatus", "==", statusFilter));

            if (dateFilter === 'personalizado' && customStartDate && customEndDate) {
                q = query(q, where("createdAt", ">=", customStartDate), where("createdAt", "<=", customEndDate));
            } else {
                const { startDate: filterStartDate, endDate: filterEndDate } = getDateRange(dateFilter);
                if (filterStartDate && filterEndDate) {
                     q = query(q, where("createdAt", ">=", filterStartDate), where("createdAt", "<", filterEndDate));
                }
            }

            unsubscribePedidos = onSnapshot(q, (snapshot) => {
                let focusedPedidoId = null;
                if (document.body.classList.contains('search-active') && currentSearchIndex > -1 && searchMatches[currentSearchIndex]) {
                    const oldRow = searchMatches[currentSearchIndex].element.closest('tr');
                    if (oldRow) {
                        focusedPedidoId = oldRow.dataset.id;
                    }
                }

                cuerpoTablaPedidos.innerHTML = '';

                const totalFiltrados = snapshot.size;
                let sumaFiltradaTotal = 0;
                snapshot.docs.forEach(doc => {
                    sumaFiltradaTotal += Number(doc.data().precio) || 0;
                });

                contadorPedidosFiltrados.textContent = `${totalFiltrados} filtrados`;
                contadorSumaFiltrada.textContent = formatCurrency(sumaFiltradaTotal);
                
                const defaultDateFilter = (auth.currentUser && auth.currentUser.email === 'alex@dekoor.com') ? 'hoy' : 'ultimos-10-dias';
                const isDefaultView = !productoFilter && !statusFilter && dateFilter === defaultDateFilter && !customStartDate;
                
                contadorPedidosFiltrados.classList.toggle('visible', !isDefaultView);
                if(isDefaultView) {
                    contadorSumaFiltrada.classList.remove('visible');
                    filteredCounterClicks = 0;
                }

                if (snapshot.empty) {
                    cuerpoTablaPedidos.innerHTML = `<tr><td colspan="11" class="empty-cell">Aún no hay pedidos registrados que coincidan con los filtros. 😊</td></tr>`;
                    return;
                }

                const allPedidosData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const ordersToHighlight = new Set();

                for (let i = 0; i < allPedidosData.length; i++) {
                    const orderA = allPedidosData[i];
                    if (!orderA.telefono || !orderA.createdAt || typeof orderA.createdAt.toDate !== 'function') continue;
                    for (let j = 0; j < allPedidosData.length; j++) {
                        if (i === j) continue;
                        const orderB = allPedidosData[j];
                        if (!orderB.telefono || !orderB.createdAt || typeof orderB.createdAt.toDate !== 'function') continue;
                        if (orderA.telefono === orderB.telefono) {
                            try {
                                const dateA = orderA.createdAt.toDate();
                                const dateB = orderB.createdAt.toDate();
                                const diffInHours = Math.abs(dateA.getTime() - dateB.getTime()) / 36e5;

                                if (diffInHours < 24) {
                                    ordersToHighlight.add(orderA.id);
                                    ordersToHighlight.add(orderB.id);
                                }
                            } catch (e) {
                                console.warn("Error comparing dates for phone highlighting:", e, orderA, orderB);
                            }
                        }
                    }
                }

                allPedidosData.forEach((pedido) => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = pedido.id;

                    tr.addEventListener('click', (event) => {
                        if (event.target.closest('button, a, .status-display, input, select, textarea, img')) return;
                        if (document.body.classList.contains('search-active')) return;

                        const isCurrentlySelected = tr.classList.contains('selected-row');
                        if (currentlySelectedRow) currentlySelectedRow.classList.remove('selected-row');
                        if (!isCurrentlySelected) {
                            tr.classList.add('selected-row');
                            currentlySelectedRow = tr;
                            selectedRowId = tr.dataset.id;
                        } else {
                            currentlySelectedRow = null;
                            selectedRowId = null;
                        }
                    });

                    const consecutiveOrderNumber = pedido.consecutiveOrderNumber || 'N/A';
                    const fechaFormateada = formatFirebaseTimestamp(pedido.createdAt);
                    const precioFormateado = formatCurrency(pedido.precio);
                    const vendedor = pedido.vendedor || '<em>N/A</em>';
                    const telefonoOriginal = pedido.telefono || '-';
                    const estatus = pedido.estatus || 'Sin estatus';
                    const comentarios = pedido.comentarios || '-';
                    const productoNombre = pedido.producto || '<em>N/A</em>';
                    const datosProductoTexto = pedido.datosProducto || '-';
                    const datosPromocionTexto = pedido.datosPromocion || '-';
                    
                    const orderPhotoUrls = pedido.fotoUrls || (pedido.fotoUrl ? [pedido.fotoUrl] : []);
                    const promoPhotoUrls = pedido.fotoPromocionUrls || (pedido.fotoPromocionUrl ? [pedido.fotoPromocionUrl] : []);

                    const createTd = (content, isHtml = false) => {
                        const td = document.createElement('td');
                        if (isHtml) td.innerHTML = content; else td.textContent = content;
                        return td;
                    };
                    
                    const createDatosCell = (photoUrls, texto, orderId, type) => {
                        const td = createTd('');
                        const container = document.createElement('div');
                        container.className = 'datos-container';
                        
                        if (photoUrls.length > 0) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'img-container';
                            const img = document.createElement('img');
                            img.src = photoUrls[0];
                            img.alt = `Foto de ${type}`;
                            img.addEventListener('click', (e) => {
                                e.stopPropagation();
                                abrirModalImagen(photoUrls, 0, `DH${orderId}`);
                            });
                            imgContainer.appendChild(img);
                            
                            if (photoUrls.length > 1) {
                                const badge = document.createElement('span');
                                badge.className = 'photo-count-badge';
                                badge.textContent = `+${photoUrls.length - 1}`;
                                badge.title = `${photoUrls.length} fotos en total`;
                                imgContainer.appendChild(badge);
                            }
                            container.appendChild(imgContainer);
                        } else {
                            const ph = document.createElement('span');
                            ph.className = 'foto-placeholder'; ph.textContent = '-';
                            container.appendChild(ph);
                        }
                        
                        const textoSpan = document.createElement('span');
                        textoSpan.className = 'datos-text';
                        textoSpan.innerHTML = texto;
                        container.appendChild(textoSpan);
                        td.appendChild(container);
                        return td;
                    };

                    tr.appendChild(createTd(consecutiveOrderNumber !== 'N/A' ? `DH${consecutiveOrderNumber}` : 'N/A'));
                    tr.appendChild(createTd(fechaFormateada));
                    tr.appendChild(createTd(vendedor, true));
                    
                    // MODIFIED: Phone Column with Checkbox on the left
                    const telefonoTd = document.createElement('td');
                    const phoneActionsContainer = document.createElement('div');
                    phoneActionsContainer.className = 'phone-actions-container';

                    if (telefonoOriginal !== '-') {
                        // Checkbox (now first)
                        const checkboxContainer = document.createElement('label');
                        checkboxContainer.className = 'phone-checkbox-container';
                        checkboxContainer.title = 'Marcar como verificado';

                        const checkboxInput = document.createElement('input');
                        checkboxInput.type = 'checkbox';
                        checkboxInput.checked = pedido.telefonoVerificado === true;
                        checkboxInput.addEventListener('change', (e) => {
                            e.stopPropagation();
                            actualizarVerificacionTelefono(pedido.id, e.target.checked);
                        });

                        const checkmarkSpan = document.createElement('span');
                        checkmarkSpan.className = 'checkmark';

                        checkboxContainer.appendChild(checkboxInput);
                        checkboxContainer.appendChild(checkmarkSpan);
                        phoneActionsContainer.appendChild(checkboxContainer);
                    }

                    const telefonoSpan = document.createElement('span');
                    telefonoSpan.textContent = telefonoOriginal;
                    if (ordersToHighlight.has(pedido.id)) {
                        telefonoSpan.style.color = 'red';
                        telefonoSpan.style.fontWeight = 'bold';
                        telefonoSpan.title = 'Este número fue registrado múltiples veces en menos de 24 horas.';
                    }
                    phoneActionsContainer.appendChild(telefonoSpan);

                    if (telefonoOriginal !== '-') {
                        // Copy Button (now last)
                        const copyButton = document.createElement('button');
                        copyButton.className = 'copy-phone-button';
                        copyButton.title = 'Copiar teléfono';
                        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                        copyButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            navigator.clipboard.writeText(telefonoOriginal).then(() => {
                                copyButton.classList.add('copied');
                                copyButton.innerHTML = '<i class="fas fa-check"></i>';
                                showCopyToast("¡Teléfono copiado!", "success");
                                setTimeout(() => {
                                    copyButton.classList.remove('copied');
                                    copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                                }, 1500);
                            }).catch(err => console.error('Error al copiar el teléfono: ', err));
                        });
                        phoneActionsContainer.appendChild(copyButton);
                    }
                    telefonoTd.appendChild(phoneActionsContainer);
                    tr.appendChild(telefonoTd);
                    // END MODIFICATION
                    
                    // MODIFIED: Estatus Column with Checkbox
                    const estatusTdCell = createTd('');
                    const statusActionsContainer = document.createElement('div');
                    statusActionsContainer.className = 'status-actions-container';

                    // Checkbox
                    const checkboxContainerEstatus = document.createElement('label');
                    checkboxContainerEstatus.className = 'status-checkbox-container';
                    checkboxContainerEstatus.title = 'Marcar como verificado';

                    const checkboxInputEstatus = document.createElement('input');
                    checkboxInputEstatus.type = 'checkbox';
                    checkboxInputEstatus.checked = pedido.estatusVerificado === true;
                    checkboxInputEstatus.addEventListener('change', (e) => {
                        e.stopPropagation();
                        actualizarVerificacionEstatus(pedido.id, e.target.checked);
                    });

                    const checkmarkSpanEstatus = document.createElement('span');
                    checkmarkSpanEstatus.className = 'checkmark';

                    checkboxContainerEstatus.appendChild(checkboxInputEstatus);
                    checkboxContainerEstatus.appendChild(checkmarkSpanEstatus);
                    statusActionsContainer.appendChild(checkboxContainerEstatus);

                    // Estatus display (existing logic)
                    const estatusSpan = document.createElement('span');
                    estatusSpan.className = `status-display status-${estatus.toLowerCase().replace(/\s+/g, '-')}`;
                    estatusSpan.textContent = estatus;
                    estatusSpan.title = "Clic para cambiar estatus";
                    estatusSpan.addEventListener('click', (e) => {
                        e.stopPropagation();
                        mostrarMenuEstatus(e, pedido.id, estatus)
                    });
                    statusActionsContainer.appendChild(estatusSpan);
                    
                    estatusTdCell.appendChild(statusActionsContainer);
                    tr.appendChild(estatusTdCell);
                    // END MODIFICATION

                    const comentariosTd = createTd(comentarios);
                    comentariosTd.classList.add('comment-cell');
                    comentariosTd.dataset.fullText = comentarios;
                    comentariosTd.title = 'Doble clic para ver el comentario completo';
                    tr.appendChild(comentariosTd);

                    tr.appendChild(createTd(productoNombre, true));
                    tr.appendChild(createDatosCell(orderPhotoUrls, datosProductoTexto, consecutiveOrderNumber, 'Pedido'));
                    tr.appendChild(createDatosCell(promoPhotoUrls, datosPromocionTexto, consecutiveOrderNumber, 'Promo'));
                    tr.appendChild(createTd(precioFormateado));

                    const accionesTd = createTd('');
                    const editButton = document.createElement('button');
                    editButton.className = 'action-button edit-button';
                    editButton.innerHTML = '<i class="fas fa-edit"></i> Editar';
                    editButton.title = 'Editar Pedido';
                    editButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        abrirModalPedido(pedido);
                    });
                    accionesTd.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'action-button delete-button';
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> Borrar';
                    deleteButton.title = 'Borrar Pedido';
                    deleteButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        abrirModalConfirmarBorrado(pedido.id, pedido)
                    });
                    accionesTd.appendChild(deleteButton);
                    tr.appendChild(accionesTd);

                    cuerpoTablaPedidos.appendChild(tr);
                });
                
                preloadAllImagesInBackground(allPedidosData);

                if (selectedRowId) {
                    const rowToReselect = cuerpoTablaPedidos.querySelector(`tr[data-id="${selectedRowId}"]`);
                    if (rowToReselect) {
                        rowToReselect.classList.add('selected-row');
                        currentlySelectedRow = rowToReselect;
                    } else {
                        selectedRowId = null;
                        currentlySelectedRow = null;
                    }
                }

                if(document.body.classList.contains('search-active')) {
                    performSearch(false, focusedPedidoId);
                }

            }, (error) => {
                console.error("Error al obtener pedidos:", error);
                cuerpoTablaPedidos.innerHTML = `<tr><td colspan="11" class="empty-cell" style="color: #d9534f;">Hubo un error al cargar los pedidos.</td></tr>`;
            });
        }

        async function borrarPedido() {
            if (!auth.currentUser || !pedidoParaBorrarId || !pedidoParaBorrarData) return;

            const pedidoRef = doc(db, "pedidos", pedidoParaBorrarId);
            const originalButtonText = btnConfirmarBorradoDefinitivo.innerHTML;
            btnConfirmarBorradoDefinitivo.disabled = true;
            btnCancelarBorrado.disabled = true;
            btnConfirmarBorradoDefinitivo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Borrando...';
            if(mensajeErrorConfirmacion) mensajeErrorConfirmacion.textContent = '';

            try {
                const photoUrlsToDelete = [
                    ...(pedidoParaBorrarData.fotoUrls || []),
                    ...(pedidoParaBorrarData.fotoPromocionUrls || [])
                ];
                if (pedidoParaBorrarData.fotoUrl) photoUrlsToDelete.push(pedidoParaBorrarData.fotoUrl);
                if (pedidoParaBorrarData.fotoPromocionUrl) photoUrlsToDelete.push(pedidoParaBorrarData.fotoPromocionUrl);

                const deletePromises = photoUrlsToDelete.map(url => {
                    try {
                        const storageRef = ref(storage, url);
                        return deleteObject(storageRef);
                    } catch (error) {
                        console.warn("Error eliminando foto del Storage (ignorado):", error.code, error.message);
                        return Promise.resolve();
                    }
                });
                await Promise.all(deletePromises);
                
                await deleteDoc(pedidoRef);
                cerrarModalConfirmarBorrado();
            } catch (error) {
                console.error("Error al borrar pedido: ", error);
                if(mensajeErrorConfirmacion) mensajeErrorConfirmacion.textContent = `Error al borrar: ${error.message}. Intenta de nuevo.`;
                btnConfirmarBorradoDefinitivo.disabled = false;
                btnCancelarBorrado.disabled = false;
                btnConfirmarBorradoDefinitivo.innerHTML = originalButtonText;
            }
        }

        function populateProductFilter() {
             if (!filtroProductoSelect) return;
             const currentValue = filtroProductoSelect.value;
             filtroProductoSelect.innerHTML = '<option value="">Todos los productos</option>';
             getDocs(collection(db, "pedidos")).then((querySnapshot) => {
                 const productNames = new Set();
                 querySnapshot.forEach((doc) => { if (doc.data().producto) productNames.add(doc.data().producto); });
                 Array.from(productNames).sort().forEach(product => {
                     const option = document.createElement('option');
                     option.value = product; option.textContent = product;
                     filtroProductoSelect.appendChild(option);
                 });
                 if (Array.from(productNames).includes(currentValue)) {
                    filtroProductoSelect.value = currentValue;
                 }
             }).catch(error => console.error("Error fetching product names for filter:", error));
        }

        function populateStatusFilter() {
            if (!filtroEstatusSelect) return;
            filtroEstatusSelect.innerHTML = '<option value="">Todos los estatus</option>';
            statusOptions.forEach(status => {
                const option = document.createElement('option');
                option.value = status.value;
                option.textContent = status.text;
                filtroEstatusSelect.appendChild(option);
            });
        }

        function mostrarMenuEstatus(event, pedidoId, currentStatus) {
            event.stopPropagation();
            cerrarMenuEstatus();

            const clickedElement = event.currentTarget;
            const clickedRect = clickedElement.getBoundingClientRect();

            activeCircularMenu = document.createElement('div');
            activeCircularMenu.className = 'circular-menu-container';

            const infoBar = document.createElement('div');
            infoBar.className = 'circular-menu-info-bar';
            infoBar.textContent = 'Selecciona un estado';
            activeCircularMenu.appendChild(infoBar);

            const menu = document.createElement('div');
            menu.className = 'circular-menu';
            const numItems = statusOptions.length;
            const angleStep = 360 / numItems;
            const radius = 95;

            statusOptions.forEach((option, index) => {
                const item = document.createElement('div');
                item.className = 'menu-item';
                const iconColor = option.color || 'var(--color-primary)';

                if (option.value === currentStatus) {
                    item.classList.add('active-status');
                    item.style.setProperty('color', iconColor);
                }

                item.innerHTML = `<i class="${option.icon}" style="color: ${iconColor};"></i><span>${option.text}</span>`;

                const itemAngle = (angleStep * index - 90) * (Math.PI / 180);
                const transformX = Math.cos(itemAngle) * radius;
                const transformY = Math.sin(itemAngle) * radius;
                item.style.transform = `translate(${transformX}px, ${transformY}px) scale(1)`;

                item.addEventListener('mouseover', () => {
                    item.style.transform = `translate(${transformX}px, ${transformY}px) scale(1.15)`;
                    infoBar.textContent = option.text;
                    infoBar.style.backgroundColor = iconColor;
                    infoBar.style.color = '#FFFFFF';
                });
                item.addEventListener('mouseout', () => {
                    item.style.transform = `translate(${transformX}px, ${transformY}px) scale(1)`;
                    infoBar.textContent = 'Selecciona un estado';
                    infoBar.style.backgroundColor = 'var(--color-text-light)';
                    infoBar.style.color = 'white';
                });
                item.addEventListener('click', () => {
                    actualizarEstatusPedido(pedidoId, option.value);
                    cerrarMenuEstatus();
                });
                menu.appendChild(item);
            });

            activeCircularMenu.appendChild(menu);
            document.body.appendChild(activeCircularMenu);

            const menuWidth = activeCircularMenu.offsetWidth;
            const menuHeight = activeCircularMenu.offsetHeight;

            let targetLeft = clickedRect.left + (clickedRect.width / 2) - (menuWidth / 2);
            let targetTop = clickedRect.top + (clickedRect.height / 2) - (menuHeight / 2);

            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const padding = 10;

            targetLeft = Math.max(padding, Math.min(targetLeft, viewportWidth - menuWidth - padding));
            targetTop = Math.max(padding, Math.min(targetTop, viewportHeight - menuHeight - padding));

            activeCircularMenu.style.left = `${targetLeft}px`;
            activeCircularMenu.style.top = `${targetTop}px`;

            setTimeout(() => {
                document.addEventListener('click', cerrarMenuEstatusOnClickOutside);
                document.addEventListener('keydown', cerrarMenuEstatusOnEsc);
            }, 0);
        }

        function cerrarMenuEstatus() {
            if (activeCircularMenu) activeCircularMenu.remove();
            activeCircularMenu = null;
            document.removeEventListener('click', cerrarMenuEstatusOnClickOutside);
            document.removeEventListener('keydown', cerrarMenuEstatusOnEsc);
        }
        function cerrarMenuEstatusOnClickOutside(event) {
            if (activeCircularMenu && !activeCircularMenu.contains(event.target) && !event.target.closest('.status-display')) cerrarMenuEstatus();
        }
        function cerrarMenuEstatusOnEsc(event) { if (event.key === "Escape") cerrarMenuEstatus(); }

        async function actualizarEstatusPedido(pedidoId, nuevoEstatus) {
            if (!auth.currentUser) return;
            const pedidoRef = doc(db, "pedidos", pedidoId);
            try { await updateDoc(pedidoRef, { estatus: nuevoEstatus }); }
            catch (error) {
                console.error("Error al actualizar estatus: ", error);
            }
        }
        
        async function actualizarVerificacionTelefono(pedidoId, isChecked) {
            if (!auth.currentUser) return;
            const pedidoRef = doc(db, "pedidos", pedidoId);
            try {
                await updateDoc(pedidoRef, { telefonoVerificado: isChecked });
            } catch (error) {
                console.error("Error al actualizar la verificación del teléfono: ", error);
                const checkboxInTable = cuerpoTablaPedidos.querySelector(`tr[data-id="${pedidoId}"] input[type="checkbox"]`);
                if (checkboxInTable) {
                    checkboxInTable.checked = !isChecked;
                }
                showCopyToast("Error al guardar el cambio", "error");
            }
        }

        async function actualizarVerificacionEstatus(pedidoId, isChecked) {
            if (!auth.currentUser) return;
            const pedidoRef = doc(db, "pedidos", pedidoId);
            try {
                await updateDoc(pedidoRef, { estatusVerificado: isChecked });
            } catch (error) {
                console.error("Error al actualizar la verificación del estatus: ", error);
                const checkboxInTable = cuerpoTablaPedidos.querySelector(`tr[data-id="${pedidoId}"] .status-checkbox-container input[type="checkbox"]`);
                if (checkboxInTable) {
                    checkboxInTable.checked = !isChecked;
                }
                showCopyToast("Error al guardar el cambio", "error");
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if(mensajeErrorPedido) mensajeErrorPedido.textContent = '';

            let productoFinal = pedidoProductoSelect.value;
            if (productoFinal === 'Otro') {
                productoFinal = pedidoProductoOtroInput.value.trim();
                if (!productoFinal) {
                    if(mensajeErrorPedido) mensajeErrorPedido.textContent = '¡El nombre del producto (Otro) es obligatorio!';
                    pedidoProductoOtroInput.focus(); return;
                }
            } else if (!productoFinal) {
                    if(mensajeErrorPedido) mensajeErrorPedido.textContent = '¡Debes seleccionar un producto!';
                    pedidoProductoSelect.focus(); return;
            }

            const telefono = pedidoTelefonoInput.value.trim();
            if (!telefono) {
                if(mensajeErrorPedido) mensajeErrorPedido.textContent = '¡El número de teléfono es obligatorio!';
                pedidoTelefonoInput.focus(); return;
            }

            if (!auth.currentUser) {
                if(mensajeErrorPedido) mensajeErrorPedido.textContent = 'Necesitas iniciar sesión para guardar pedidos.'; return;
            }

            const originalGuardarText = btnGuardarPedido.innerHTML;
            btnGuardarPedido.disabled = true;
            if(btnCancelarPedido) btnCancelarPedido.disabled = true;
            btnGuardarPedido.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            
            try {
                async function processPhotos(manager, initialUrls, storagePath) {
                    btnGuardarPedido.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> Subiendo fotos...`;
                    const uploadPromises = manager.map(photo => {
                        if (photo.isNew) {
                            const filePath = `${storagePath}/${Date.now()}_${photo.file.name}`;
                            const storageRefFs = ref(storage, filePath);
                            return uploadBytesResumable(storageRefFs, photo.file).then(snapshot => getDownloadURL(snapshot.ref));
                        }
                        return Promise.resolve(photo.url);
                    });

                    const finalUrls = await Promise.all(uploadPromises);
                    const finalUrlSet = new Set(finalUrls);
                    const urlsToDelete = initialUrls.filter(url => !finalUrlSet.has(url));
                    
                    const deletePromises = urlsToDelete.map(url => {
                        const oldRef = ref(storage, url);
                        return deleteObject(oldRef).catch(err => console.warn(`Failed to delete old photo:`, err))
                    });
                    await Promise.all(deletePromises);

                    return finalUrls;
                }

                const finalOrderPhotoUrls = await processPhotos(orderPhotosManager, initialOrderPhotoUrls, 'pedidos');
                const finalPromoPhotoUrls = await processPhotos(promoPhotosManager, initialPromoPhotoUrls, 'promociones');
                
                const pedidoData = {
                    producto: productoFinal,
                    vendedor: loggedInUserName,
                    telefono: telefono,
                    fotoUrls: finalOrderPhotoUrls,
                    fotoPromocionUrls: finalPromoPhotoUrls,
                    comentarios: pedidoComentariosInput.value.trim(),
                    datosProducto: pedidoDatosProductoInput.value.trim(),
                    datosPromocion: pedidoDatosPromocionInput.value.trim(),
                    precio: Number(pedidoPrecioInput.value) || 0,
                    userEmail: auth.currentUser.email
                };

                if (editingPedidoId) {
                    btnGuardarPedido.innerHTML = '<i class="fas fa-database"></i> Actualizando...';
                    const docRef = doc(db, "pedidos", editingPedidoId);
                    Object.keys(pedidoData).forEach(key => pedidoData[key] === undefined && delete pedidoData[key]);
                    await updateDoc(docRef, pedidoData);
                    cerrarModalPedido();
                } else {
                    btnGuardarPedido.innerHTML = '<i class="fas fa-database"></i> Guardando...';
                    const newOrderNumber = await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(orderCounterRef);
                        let currentCounter = counterDoc.exists() ? counterDoc.data().lastOrderNumber || 0 : 0;
                        const nextOrderNumber = (currentCounter < 1000) ? 1001 : currentCounter + 1;
                        transaction.set(orderCounterRef, { lastOrderNumber: nextOrderNumber }, { merge: true });
                        return nextOrderNumber;
                    });
                    const nuevoPedido = { 
                        ...pedidoData, 
                        consecutiveOrderNumber: newOrderNumber, 
                        createdAt: serverTimestamp(), 
                        createdBy: auth.currentUser.uid, 
                        estatus: "Sin estatus",
                        telefonoVerificado: false, 
                        estatusVerificado: false
                    };
                    await addDoc(pedidosCollectionRef, nuevoPedido);
                    cerrarModalPedido();
                    mostrarModalConfirmacionRegistro(newOrderNumber);
                }
                populateProductFilter();
            } catch (error) {
                if(mensajeErrorPedido) mensajeErrorPedido.textContent = `Error: ${error.message}. Intenta de nuevo.`;
                console.error("Error guardando pedido:", error);
            } finally {
                btnGuardarPedido.disabled = false;
                if(btnCancelarPedido) btnCancelarPedido.disabled = false;
                btnGuardarPedido.innerHTML = originalGuardarText;
            }
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function clearSearchHighlight() {
            document.querySelectorAll('mark.search-highlight-text').forEach(markNode => {
                const parent = markNode.parentNode;
                if (parent) {
                    while (markNode.firstChild) {
                        parent.insertBefore(markNode.firstChild, markNode);
                    }
                    parent.removeChild(markNode);
                    parent.normalize();
                }
            });
        }
        
        function highlightTextInNode(node, regex, matches, cell) {
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.nodeValue;
                if (regex.test(text)) {
                    const fragment = document.createDocumentFragment();
                    let lastIndex = 0;
                    text.replace(regex, (match, offset) => {
                        if (offset > lastIndex) fragment.appendChild(document.createTextNode(text.substring(lastIndex, offset)));
                        const mark = document.createElement('mark');
                        mark.className = 'search-highlight-text';
                        mark.textContent = match;
                        fragment.appendChild(mark);
                        matches.push({ element: mark, cell: cell });
                        lastIndex = offset + match.length;
                    });
                    if (lastIndex < text.length) fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                    if(node.parentNode) node.parentNode.replaceChild(fragment, node);
                }
            } else if (node.nodeType === Node.ELEMENT_NODE && !/^(script|style|mark)$/i.test(node.tagName)) {
                Array.from(node.childNodes).forEach(child => highlightTextInNode(child, regex, matches, cell));
            }
        }

        function openSearch() {
            if (searchBarContainer.style.display === 'flex') {
                searchInput.select();
                return;
            }
            if (currentlySelectedRow) {
                currentlySelectedRow.classList.remove('selected-row');
                currentlySelectedRow = null;
                selectedRowId = null;
            }
            searchBarContainer.style.display = 'flex';
            document.body.classList.add('search-active');
            searchInput.focus();
            performSearch(true);
        }

        function closeSearch() {
            document.body.classList.remove('search-active');
            searchBarContainer.style.display = 'none';
            searchInput.value = '';
            clearSearchHighlight();
            searchMatches = [];
            currentSearchIndex = -1;
            document.querySelectorAll('#cuerpoTablaPedidos tr').forEach(row => {
                row.classList.remove('search-match', 'current-search-highlight');
            });
            searchMatchIcon.style.display = 'none';
            updateSearchUI();
        }

        function updateSearchUI() {
            if(searchMatchIcon) searchMatchIcon.style.display = 'none';

            if (searchMatches.length > 0) {
                searchCounter.textContent = `${currentSearchIndex + 1}/${searchMatches.length}`;
                prevMatchBtn.disabled = false;
                nextMatchBtn.disabled = false;
                
                const currentMatch = searchMatches[currentSearchIndex];
                if (currentMatch && currentMatch.cell) {
                    const cellIndex = Array.from(currentMatch.cell.parentNode.children).indexOf(currentMatch.cell);
                    if (cellIndex === 0) { // # Pedido
                        searchMatchIcon.innerHTML = '<i class="fas fa-hashtag"></i>';
                        searchMatchIcon.style.color = '#3498db';
                        searchMatchIcon.style.display = 'inline-block';
                    } else if (cellIndex === 3) { // Teléfono
                        searchMatchIcon.innerHTML = '<i class="fas fa-phone-alt"></i>';
                        searchMatchIcon.style.color = '#96ceb4';
                        searchMatchIcon.style.display = 'inline-block';
                    }
                }

            } else {
                searchCounter.textContent = searchInput.value ? '0/0' : '';
                prevMatchBtn.disabled = true;
                nextMatchBtn.disabled = true;
            }
        }

        function navigateToCurrentMatch() {
            document.querySelectorAll('tr.current-search-highlight').forEach(row => row.classList.remove('current-search-highlight'));
            
            if (currentSearchIndex !== -1 && searchMatches.length > 0) {
                const currentMatchElement = searchMatches[currentSearchIndex].element;
                const currentRow = currentMatchElement.closest('tr');
                
                if (currentRow) {
                    currentRow.classList.add('current-search-highlight');
                    currentMatchElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                }
            }
            updateSearchUI();
        }
        
        function performSearch(isNewSearch = true, focusedPedidoId = null) {
            clearSearchHighlight();
            const searchTerm = searchInput.value.trim();
            const allRows = document.querySelectorAll('#cuerpoTablaPedidos tr');

            searchMatches = [];
            allRows.forEach(row => row.classList.remove('search-match', 'current-search-highlight'));

            if (!searchTerm) {
                document.body.classList.remove('search-active');
                currentSearchIndex = -1;
                updateSearchUI();
                return;
            }
            
            document.body.classList.add('search-active');
            const regex = new RegExp(escapeRegExp(searchTerm), 'gi');
            const matchedRows = new Set();
            
            allRows.forEach(row => {
                row.querySelectorAll('td').forEach(cell => {
                    highlightTextInNode(cell, regex, searchMatches, cell);
                });
                if (row.querySelector('mark.search-highlight-text')) {
                    matchedRows.add(row);
                }
            });

            allRows.forEach(row => {
                if (matchedRows.has(row)) {
                    row.classList.add('search-match');
                }
            });

            if (searchMatches.length > 0) {
                let newIndex = -1;
                if (!isNewSearch && focusedPedidoId) {
                    newIndex = searchMatches.findIndex(match => match.element.closest('tr')?.dataset.id === focusedPedidoId);
                }
                currentSearchIndex = (newIndex !== -1) ? newIndex : 0;
                navigateToCurrentMatch();
            } else {
                currentSearchIndex = -1;
            }
            updateSearchUI();
        }

        function navigateMatches(direction) {
            if (searchMatches.length === 0) return;
            currentSearchIndex = (direction === 'next') 
                ? (currentSearchIndex + 1) % searchMatches.length
                : (currentSearchIndex - 1 + searchMatches.length) % searchMatches.length;
            navigateToCurrentMatch();
        }
        
        function showCopyToast(message, type = 'success') {
            if(!copyToast) return;
            copyToast.textContent = message;
            
            copyToast.className = 'copy-toast show'; 
            if (type === 'success') {
                copyToast.classList.add('success');
            } else if (type === 'error') {
                copyToast.classList.add('error');
            }

            setTimeout(() => {
                copyToast.classList.remove('show');
            }, 2000);
        }
        
        function showPhotoCopyToast() {
            if (!photoCopyToast) return;
            photoCopyToast.classList.add('show');
            setTimeout(() => {
                photoCopyToast.classList.remove('show');
            }, 2200);
        }
        
        function inicializarDatePicker() {
            datePickerInstance = flatpickr("#filtroFechaPersonalizada", {
                mode: "range",
                dateFormat: "Y-m-d",
                locale: "es",
                altInput: true,
                altFormat: "j F, Y",
                allowInput: true,
                onClose: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 1) {
                        instance.setDate([selectedDates[0], selectedDates[0]], true);
                    }
                }
            });
        }

        function actualizarContadorHoy() {
            if (unsubscribeHoy) unsubscribeHoy();

            const { startDate, endDate } = getDateRange('hoy');
            if (!startDate || !endDate) return;

            const q = query(pedidosCollectionRef, where("createdAt", ">=", startDate), where("createdAt", "<", endDate));
            
            unsubscribeHoy = onSnapshot(q, (snapshot) => {
                contadorPedidosHoy.textContent = snapshot.size;
            }, (error) => {
                console.error("Error getting today's orders count:", error);
                contadorPedidosHoy.textContent = 'X';
            });
        }


        // --- Event Listeners & Initial Calls ---
        
        applySavedTheme();

        if (pedidoProductoSelect) {
            pedidoProductoSelect.addEventListener('change', () => {
                const esOtro = pedidoProductoSelect.value === 'Otro';
                pedidoProductoOtroInput.style.display = esOtro ? 'block' : 'none';
                pedidoProductoOtroInput.required = esOtro;
                if (esOtro) {
                    pedidoProductoOtroInput.value = '';
                    pedidoProductoOtroInput.focus();
                }
            });
        }
        
        setupDragAndDrop(fileInputContainerProducto, pedidoFotoFileInput, orderPhotosManager, renderOrderPhotoPreviews);
        setupDragAndDrop(fileInputContainerPromocion, pedidoFotoPromocionFileInput, promoPhotosManager, renderPromoPhotoPreviews);
        setupPasteListener(fileInputContainerProducto, orderPhotosManager, renderOrderPhotoPreviews);
        setupPasteListener(fileInputContainerPromocion, promoPhotosManager, renderPromoPhotoPreviews);

        if (mismaFotoCheckbox) {
            mismaFotoCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    promoPhotosManager.length = 0; 
                    const newPromoPhotos = orderPhotosManager.map(p => ({ ...p, isNew: true, file: p.file }));
                    promoPhotosManager.push(...newPromoPhotos);
                    renderPromoPhotoPreviews();
                } 
            });
        }

        onAuthStateChanged(auth, (user) => {
            const handleAuth = () => {
                if (user) {
                    if (user.email) {
                        const emailParts = user.email.split('@');
                        const name = emailParts[0];
                        loggedInUserName = name.charAt(0).toUpperCase() + name.slice(1);
                        usuarioLogueado.textContent = `¡Hola de nuevo, ${loggedInUserName}! 👋`;
                    } else {
                        loggedInUserName = 'Usuario';
                        usuarioLogueado.textContent = `¡Bienvenido, ${loggedInUserName}! 👋`;
                    }

                    seccionPedidos.classList.add('visible');
                    seccionLogin.classList.remove('visible');

                    populateStatusFilter();
                    inicializarDatePicker();
                    actualizarContadorHoy();

                    let fechaPorDefecto = 'ultimos-10-dias';
                    if (user.email === 'alex@dekoor.com') {
                        fechaPorDefecto = 'hoy';
                    }
                    filtroFechaSelect.value = fechaPorDefecto;
                    
                    cargarPedidos(filtroProductoSelect.value, filtroFechaSelect.value, filtroEstatusSelect.value);
                    populateProductFilter();
                } else {
                    loggedInUserName = '';
                    usuarioLogueado.textContent = '';
                    seccionLogin.classList.add('visible');
                    seccionPedidos.classList.remove('visible');
                    
                    if (unsubscribePedidos) unsubscribePedidos();
                    if (unsubscribeHoy) unsubscribeHoy();
                    if (cuerpoTablaPedidos) cuerpoTablaPedidos.innerHTML = '';
                    if (contadorPedidosHoy) contadorPedidosHoy.textContent = '0';
                    if (contadorPedidosFiltrados) contadorPedidosFiltrados.classList.remove('visible');
                    cerrarMenuEstatus();
                }

                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 500);
            };
            
            const elapsedTime = Date.now() - startTime;
            const minLoadingTime = 1500;
            const remainingTime = Math.max(0, minLoadingTime - elapsedTime);

            setTimeout(handleAuth, remainingTime);
        });

        if (formularioLogin) {
             formularioLogin.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = inputEmail.value;
                const password = inputPassword.value;
                mensajeErrorLogin.textContent = '';
                const loginButton = formularioLogin.querySelector('button[type="submit"]');
                const originalButtonText = loginButton.innerHTML;
                loginButton.disabled = true;
                loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ingresando...';
                signInWithEmailAndPassword(auth, email, password)
                  .catch((error) => {
                    let errorAmigable = 'Ups! Algo salió mal.';
                    if (['auth/user-not-found', 'auth/wrong-password', 'auth/invalid-credential'].includes(error.code)) {
                        errorAmigable = 'El correo o la contraseña no coinciden.';
                    } else if (error.code === 'auth/invalid-email') {
                         errorAmigable = 'El formato del correo es incorrecto.';
                    }
                    mensajeErrorLogin.textContent = errorAmigable;
                  })
                  .finally(() => {
                     loginButton.disabled = false; loginButton.innerHTML = originalButtonText;
                  });
            });
        }
        
        if (formularioNuevoPedido) formularioNuevoPedido.addEventListener('submit', handleFormSubmit);

        if (btnCerrarSesion) btnCerrarSesion.addEventListener('click', () => signOut(auth).catch(e => console.error("Error al cerrar sesión.",e)));

        if (btnAplicarFiltros) {
            btnAplicarFiltros.addEventListener('click', () => {
                const producto = filtroProductoSelect.value;
                const fecha = filtroFechaSelect.value;
                const estatus = filtroEstatusSelect.value;
                let fechaInicio = null;
                let fechaFin = null;

                if (fecha === 'personalizado') {
                    const selectedDates = datePickerInstance.selectedDates;
                    if (selectedDates.length > 0) {
                        const start = selectedDates[0];
                        start.setHours(0, 0, 0, 0);
                        fechaInicio = Timestamp.fromDate(start);

                        const end = selectedDates.length > 1 ? selectedDates[1] : selectedDates[0];
                        end.setHours(23, 59, 59, 999);
                        fechaFin = Timestamp.fromDate(end);
                    } else {
                        showCopyToast("Por favor, selecciona una fecha o un rango.", "error");
                        return;
                    }
                }
                
                contadorSumaFiltrada.classList.remove('visible');
                filteredCounterClicks = 0;
                cargarPedidos(producto, fecha, estatus, fechaInicio, fechaFin);
            });
        }

        if (btnBorrarFiltros) {
            btnBorrarFiltros.addEventListener('click', () => {
                filtroProductoSelect.value = '';
                let fechaPorDefecto = 'ultimos-10-dias';
                if (auth.currentUser && auth.currentUser.email === 'alex@dekoor.com') {
                    fechaPorDefecto = 'hoy';
                }
                filtroFechaSelect.value = fechaPorDefecto;
                filtroEstatusSelect.value = '';

                if(datePickerInstance) {
                    datePickerInstance.clear();
                }
                rangoFechaPersonalizadoContainer.style.display = 'none';
                contadorPedidosFiltrados.classList.remove('visible');
                contadorSumaFiltrada.classList.remove('visible');
                filteredCounterClicks = 0;

                cargarPedidos('', fechaPorDefecto, '');
            });
        }

        if (filtroFechaSelect) {
            filtroFechaSelect.addEventListener('change', (e) => {
                if (e.target.value === 'personalizado') {
                    rangoFechaPersonalizadoContainer.style.display = 'block';
                } else {
                    rangoFechaPersonalizadoContainer.style.display = 'none';
                }
            });
        }

        if (contadorPedidosFiltrados) {
            contadorPedidosFiltrados.addEventListener('click', () => {
                const now = Date.now();
                if (now - lastFilteredCounterClickTime > 1500) { // Reset after 1.5 seconds
                    filteredCounterClicks = 1;
                } else {
                    filteredCounterClicks++;
                }
                lastFilteredCounterClickTime = now;

                if (filteredCounterClicks >= 5) {
                    contadorSumaFiltrada.classList.toggle('visible');
                }
            });
        }


        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                darkModeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i> Modo Claro' : '<i class="fas fa-moon"></i> Modo Oscuro';
            });
        }

        if (tablaContainer && scrollToTopBtn) {
            tablaContainer.addEventListener('scroll', () => {
                scrollToTopBtn.style.display = (tablaContainer.scrollTop > 100) ? 'block' : 'none';
            });
            scrollToTopBtn.addEventListener('click', () => {
                tablaContainer.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
        
        // Modal Event Listeners
        if (btnMostrarFormularioPedido) btnMostrarFormularioPedido.addEventListener('click', () => abrirModalPedido());
        if (btnCerrarModal) btnCerrarModal.addEventListener('click', cerrarModalPedido);
        if (btnCancelarPedido) btnCancelarPedido.addEventListener('click', cerrarModalPedido);

        if (modalImagenPedido) modalImagenPedido.addEventListener('click', (e) => { if (e.target === modalImagenPedido) cerrarModalImagen(); });
        if (modalConfirmarBorrado) modalConfirmarBorrado.addEventListener('click', (e) => { if (e.target === modalConfirmarBorrado) cerrarModalConfirmarBorrado(); });
        if (modalConfirmacionRegistro) modalConfirmacionRegistro.addEventListener('click', (e) => { if (e.target === modalConfirmacionRegistro) cerrarModalConfirmacionRegistro(); });
        if (modalComentario) modalComentario.addEventListener('click', (e) => { if (e.target === modalComentario) cerrarModalComentario(); });
        
        if (btnCerrarModalImagen) btnCerrarModalImagen.addEventListener('click', cerrarModalImagen);
        if (btnCerrarModalConfirmarBorrado) btnCerrarModalConfirmarBorrado.addEventListener('click', cerrarModalConfirmarBorrado);
        if (btnCancelarBorrado) btnCancelarBorrado.addEventListener('click', cerrarModalConfirmarBorrado);
        if (btnConfirmarBorradoDefinitivo) btnConfirmarBorradoDefinitivo.addEventListener('click', borrarPedido);
        if (btnCerrarModalComentarioTop) btnCerrarModalComentarioTop.addEventListener('click', cerrarModalComentario);
        if (btnCerrarModalComentarioBottom) btnCerrarModalComentarioBottom.addEventListener('click', cerrarModalComentario);
        if (btnCerrarModalConfirmacionRegistro) btnCerrarModalConfirmacionRegistro.addEventListener('click', cerrarModalConfirmacionRegistro);

        if (btnCopiarNumeroPedidoConfirmacion) {
            btnCopiarNumeroPedidoConfirmacion.addEventListener('click', () => {
                navigator.clipboard.writeText(numeroPedidoConfirmacionSpan.textContent).then(() => {
                    btnCopiarNumeroPedidoConfirmacion.classList.add('copied');
                    btnCopiarNumeroPedidoConfirmacion.innerHTML = '<i class="fas fa-check"></i>';
                    showCopyToast(`¡Copiado: ${numeroPedidoConfirmacionSpan.textContent}!`, 'success');
                    setTimeout(() => {
                        btnCopiarNumeroPedidoConfirmacion.classList.remove('copied');
                        btnCopiarNumeroPedidoConfirmacion.innerHTML = '<i class="fas fa-copy"></i>';
                    }, 1500);
                });
            });
        }
        if (cuerpoTablaPedidos) {
            cuerpoTablaPedidos.addEventListener('dblclick', e => {
                if (e.target && e.target.classList.contains('comment-cell')) {
                    abrirModalComentario(e.target.dataset.fullText);
                }
            });
        }
        
        // --- Centralized Keydown Handler ---
        document.addEventListener('keydown', async (e) => {
            if (e.ctrlKey && (e.key === 'c' || e.key === 'C')) {
                if (modalNuevoPedido.style.display === 'flex' && selectedThumbnail.element) {
                    e.preventDefault(); 

                    const imgToCopy = selectedThumbnail.element.querySelector('img');
                    if (!imgToCopy) return;

                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d'); // BUG-FIX: Changed 'd' to '2d'
                        
                        const image = new Image();
                        image.crossOrigin = "Anonymous";
                        image.onload = () => {
                            canvas.width = image.naturalWidth;
                            canvas.height = image.naturalHeight;
                            ctx.drawImage(image, 0, 0);

                            canvas.toBlob(async (blob) => {
                                if (blob) {
                                    try {
                                        await navigator.clipboard.write([
                                            new ClipboardItem({ 'image/png': blob })
                                        ]);
                                        showPhotoCopyToast();
                                    } catch (writeErr) {
                                        console.error('Error al escribir en el portapapeles: ', writeErr);
                                        showCopyToast("Error al copiar imagen", "error");
                                    }
                                }
                            }, 'image/png');
                        };
                        image.onerror = () => {
                             console.error("No se pudo cargar la imagen para copiarla.");
                             showCopyToast("Error al cargar la imagen", "error");
                        };
                        image.src = imgToCopy.src;

                    } catch (err) {
                        console.error('Error al procesar la imagen para copiar: ', err);
                        showCopyToast("Error al procesar la imagen", "error");
                    }
                }
            }

            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                openSearch();
            }
            
            if (e.ctrlKey && (e.key === 'e' || e.key === 'E')) {
                if (document.body.classList.contains('search-active') && currentSearchIndex > -1 && searchMatches.length > 0) {
                    e.preventDefault(); 

                    const currentMatch = searchMatches[currentSearchIndex];
                    if (currentMatch && currentMatch.element) {
                        const currentRow = currentMatch.element.closest('tr');
                        if (currentRow && currentRow.cells[0]) {
                            const pedidoId = currentRow.dataset.id;
                            const orderNumberText = currentRow.cells[0].textContent;

                            if (pedidoId) {
                                const nuevoEstatus = "Foto enviada";
                                
                                await actualizarEstatusPedido(pedidoId, nuevoEstatus);
                                
                                const statusDisplay = currentRow.querySelector('.status-display');
                                if (statusDisplay) {
                                    statusDisplay.textContent = nuevoEstatus;
                                    statusDisplay.className = 'status-display';
                                    statusDisplay.classList.add(`status-${nuevoEstatus.toLowerCase().replace(/\s+/g, '-')}`);
                                }

                                showCopyToast(`Pedido ${orderNumberText} actualizado a "${nuevoEstatus}"`, 'success');
                            }
                        }
                    }
                }
            }

            if (e.key === 'Escape') {
                if (document.body.classList.contains('search-active')) closeSearch();
                else if (activeCircularMenu) cerrarMenuEstatus();
                else if (modalComentario && modalComentario.style.display === 'flex') cerrarModalComentario();
                else if (modalImagenPedido && modalImagenPedido.style.display === 'flex') cerrarModalImagen();
                else if (modalNuevoPedido && modalNuevoPedido.style.display === 'flex') cerrarModalPedido();
            }

            if (document.body.classList.contains('search-active') && searchInput === document.activeElement && e.key === 'Enter') {
                e.preventDefault();
                navigateMatches(e.shiftKey ? 'prev' : 'next');
            }
        });

        document.addEventListener('click', (e) => {
            if (selectedThumbnail.element && !e.target.closest('.previews-container')) {
                selectedThumbnail.element.classList.remove('selected');
                selectedThumbnail = { element: null, manager: null, index: -1 };
            }
        });

        searchInput.addEventListener('input', () => performSearch(true));
        closeSearchBtn.addEventListener('click', closeSearch);
        prevMatchBtn.addEventListener('click', () => navigateMatches('prev'));
        nextMatchBtn.addEventListener('click', () => navigateMatches('next'));

        modalImagenNextBtn.addEventListener('click', () => {
            if (modalImageViewer.currentIndex < modalImageViewer.urls.length - 1) {
                modalImageViewer.currentIndex++;
                updateModalImageView();
            }
        });

        modalImagenPrevBtn.addEventListener('click', () => {
            if (modalImageViewer.currentIndex > 0) {
                modalImageViewer.currentIndex--;
                updateModalImageView();
            }
        });
    });
</script>
</body>
</html>
