<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="facebook-domain-verification" content="m7n0ij9b0l1p6pe3g4tum7xjuxz685" />
    <title>WhatsApp CRM ✨</title>
    
    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>


    <!-- Estilos Personalizados -->
    <link rel="stylesheet" href="css/style.css"> <!-- Ruta actualizada -->

</head>
<body class="antialiased">

    <!-- Pantalla de Carga -->
    <div id="loading-overlay">
        <div class="text-center">
            <i class="fab fa-whatsapp text-6xl text-green-500 animate-pulse"></i>
            <p class="mt-4 text-lg font-semibold">Cargando CRM...</p>
        </div>
    </div>

    <!-- Vista de Login -->
    <div id="login-view" class="h-screen w-screen hidden items-center justify-center p-4">
        <div class="login-container">
            <h1><i class="fab fa-whatsapp-square"></i> CRM Login</h1>
            <form id="login-form">
                <div>
                    <label for="login-email" class="text-left">Correo Electrónico:</label>
                    <input type="email" id="login-email" required placeholder="tu.correo@ejemplo.com">
                </div>
                <div>
                    <label for="login-password" class="text-left">Contraseña:</label>
                    <input type="password" id="login-password" required placeholder="••••••••">
                </div>
                <div id="login-error-message"></div>
                <button type="submit" class="btn btn-primary mt-4"><i class="fas fa-sign-in-alt mr-2"></i> Ingresar</button>
            </form>
        </div>
    </div>
    
    <!-- Contenedor Principal de la App -->
    <div id="app-container" class="h-screen w-screen flex-col hidden">
        <header id="app-header" class="p-4 shadow-md z-10 flex items-center justify-between">
             <div class="flex items-center">
                <button id="tag-sidebar-toggle" onclick="toggleTagSidebar()" class="text-xl text-gray-600 hover:text-primary mr-4"><i class="fas fa-bars"></i></button>
                <h1 class="text-2xl font-bold"><i class="fab fa-whatsapp text-green-500"></i> Dekoor</h1>
             </div>
             <div id="user-info" class="text-sm text-gray-600"></div>
        </header>
        <div id="error-container" class="bg-yellow-200 text-yellow-800 p-3 text-center hidden">
            <p><strong><i class="fas fa-exclamation-triangle"></i> Aviso:</strong> <span id="error-message"></span></p>
        </div>
        <div id="app-body">
            <aside id="main-sidebar" class="h-full flex flex-col p-4">
                <nav class="flex-1">
                    <a onclick="navigateTo('chats')" data-view="chats" class="nav-item active">
                        <i class="fas fa-comments"></i>
                        <span class="sidebar-text">Chats</span>
                    </a>
                    <a onclick="navigateTo('pipeline')" data-view="pipeline" class="nav-item">
                        <i class="fas fa-stream"></i>
                        <span class="sidebar-text">Pipeline</span>
                    </a>
                    <a href="/pedidos.html" target="_blank" class="nav-item">
                        <i class="fas fa-list-alt"></i>
                        <span class="sidebar-text">Ver Pedidos</span>
                    </a>
                    <a onclick="navigateTo('contacts')" data-view="contacts" class="nav-item">
                        <i class="fas fa-address-book"></i>
                        <span class="sidebar-text">Contactos</span>
                    </a>
                    <a onclick="navigateTo('etiquetas')" data-view="etiquetas" class="nav-item">
                        <i class="fas fa-tags"></i>
                        <span class="sidebar-text">Etiquetas</span>
                    </a>
                    <a onclick="navigateTo('campanas')" data-view="campanas" class="nav-item">
                        <i class="fas fa-bullhorn"></i>
                        <span class="sidebar-text">Campañas</span>
                    </a>
                    <a onclick="navigateTo('campanas-imagen')" data-view="campanas-imagen" class="nav-item">
                        <i class="fas fa-image"></i>
                        <span class="sidebar-text">Campaña con Imagen</span>
                    </a>
                    <a onclick="navigateTo('mensajes-ads')" data-view="mensajes-ads" class="nav-item">
                        <i class="fas fa-ad"></i>
                        <span class="sidebar-text">Mensajes Ads</span>
                    </a>
                    <a onclick="navigateTo('respuestas-rapidas')" data-view="respuestas-rapidas" class="nav-item">
                        <i class="fas fa-bolt"></i>
                        <span class="sidebar-text">Respuestas rápidas</span>
                    </a>
                    
                    <!-- Menú Desplegable de IA -->
                    <div id="ia-menu">
                        <a onclick="toggleIAMenu()" class="nav-item justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-robot"></i>
                                <span class="sidebar-text">Inteligencia Artificial</span>
                            </div>
                            <i id="ia-menu-chevron" class="fas fa-chevron-down sidebar-text transition-transform"></i>
                        </a>
                        <div id="ia-submenu" class="hidden pl-4">
                            <a onclick="navigateTo('prompts-ia')" data-view="prompts-ia" class="nav-item !py-2">
                                <i class="fas fa-lightbulb w-6"></i>
                                <span class="sidebar-text">Prompts de Anuncios</span>
                            </a>
                            <a onclick="navigateTo('respuestas-ia')" data-view="respuestas-ia" class="nav-item !py-2">
                                <i class="fas fa-book w-6"></i>
                                <span class="sidebar-text">Base de Conocimiento</span>
                            </a>
                            <a onclick="navigateTo('ajustes-ia')" data-view="ajustes-ia" class="nav-item !py-2">
                                <i class="fas fa-cogs w-6"></i>
                                <span class="sidebar-text">Ajustes de IA</span>
                            </a>
                        </div>
                    </div>
                    <!-- Fin Menú IA -->

                    <a onclick="navigateTo('metricas')" data-view="metricas" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span class="sidebar-text">Métricas</span>
                    </a>

                    <a onclick="navigateTo('ajustes')" data-view="ajustes" class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span class="sidebar-text">Ajustes Generales</span>
                    </a>
                </nav>
                <div class="mt-auto">
                     <a id="logout-button" class="nav-item">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="sidebar-text">Cerrar Sesión</span>
                    </a>
                </div>
            </aside>

            <!-- Contenedor donde se renderizan las vistas -->
            <main id="main-view-container"></main>
        </div>
    </div>
    
    <!-- Contenedores de Modales -->
    <div id="image-modal" class="image-modal-backdrop" onclick="closeImageModal()">
        <div class="image-modal-content" onclick="event.stopPropagation()">
            <img id="modal-image-content" src="" alt="Vista ampliada">
            <button class="image-modal-close" onclick="closeImageModal()"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div id="quick-reply-modal" class="modal-backdrop hidden"></div>
    <div id="ad-response-modal" class="modal-backdrop hidden"></div>
    <div id="ai-ad-prompt-modal" class="modal-backdrop hidden"></div>
    <div id="edit-contact-modal" class="modal-backdrop hidden"></div>
    <div id="tag-modal" class="modal-backdrop hidden"></div>
    <div id="bot-settings-modal" class="modal-backdrop hidden"></div>
    <div id="knowledge-base-modal" class="modal-backdrop hidden"></div>
    
    <!-- NUEVOS Contenedores de Modales -->
    <div id="register-order-modal-container"></div>
    <div id="register-order-confirmation-modal-container"></div>


    <!-- Scripts de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <!-- Lógica de la Aplicación (Refactorizada y en orden correcto) -->
    <script src="js/modules/firebase-init.js"></script>
    <script src="js/modules/state.js"></script>
    <script src="js/modules/utils.js"></script>
    <script src="js/ui_templates.js"></script> 
    <script src="js/modules/api-service.js"></script>
    <script src="js/modules/ui-manager.js"></script>
    <script src="js/modules/chat-handlers.js"></script>
    <script src="js/modules/feature-handlers.js"></script>
    <script src="js/modules/main.js"></script> <!-- Carga main.js antes que auth.js -->
    <script src="js/modules/auth.js"></script> <!-- auth.js ahora puede encontrar startApp -->
    
</body>
</html>
