<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="facebook-domain-verification" content="m7n0ij9b0l1p6pe3g4tum7xjuxz685" />
    <title>WhatsApp CRM ✨</title>
    
    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Estilos Personalizados -->
    <link rel="stylesheet" href="style.css">

</head>
<body class="antialiased">

    <!-- Pantalla de Carga -->
    <div id="loading-overlay">
        <div class="text-center">
            <i class="fab fa-whatsapp text-6xl text-green-500 animate-pulse"></i>
            <p class="mt-4 text-lg font-semibold">Cargando CRM...</p>
        </div>
    </div>

    <!-- Vista de Login -->
    <div id="login-view" class="h-screen w-screen hidden items-center justify-center p-4">
        <div class="login-container">
            <h1><i class="fab fa-whatsapp-square"></i> CRM Login</h1>
            <form id="login-form">
                <div>
                    <label for="login-email" class="text-left">Correo Electrónico:</label>
                    <input type="email" id="login-email" required placeholder="tu.correo@ejemplo.com">
                </div>
                <div>
                    <label for="login-password" class="text-left">Contraseña:</label>
                    <input type="password" id="login-password" required placeholder="••••••••">
                </div>
                <div id="login-error-message"></div>
                <button type="submit" class="btn btn-primary mt-4"><i class="fas fa-sign-in-alt mr-2"></i> Ingresar</button>
            </form>
        </div>
    </div>
    
    <!-- Contenedor Principal de la App -->
    <div id="app-container" class="h-screen w-screen flex-col hidden">
        <header id="app-header" class="p-4 shadow-md z-10 flex items-center justify-between">
             <div class="flex items-center">
                <button id="tag-sidebar-toggle" onclick="toggleTagSidebar()" class="text-xl text-gray-600 hover:text-primary mr-4"><i class="fas fa-bars"></i></button>
                <h1 class="text-2xl font-bold"><i class="fab fa-whatsapp text-green-500"></i> Dekoor</h1>
             </div>
             <div id="user-info" class="text-sm text-gray-600"></div>
        </header>
        <div id="error-container" class="bg-yellow-200 text-yellow-800 p-3 text-center hidden">
            <p><strong><i class="fas fa-exclamation-triangle"></i> Aviso:</strong> <span id="error-message"></span></p>
        </div>
        <div id="app-body">
            <aside id="main-sidebar" class="h-full flex flex-col p-4">
                <nav class="flex-1">
                    <a onclick="navigateTo('chats')" data-view="chats" class="nav-item active">
                        <i class="fas fa-comments"></i>
                        <span class="sidebar-text">Chats</span>
                    </a>
                    <a onclick="navigateTo('pipeline')" data-view="pipeline" class="nav-item">
                        <i class="fas fa-stream"></i>
                        <span class="sidebar-text">Pipeline</span>
                    </a>
                    <a onclick="navigateTo('contacts')" data-view="contacts" class="nav-item">
                        <i class="fas fa-address-book"></i>
                        <span class="sidebar-text">Contactos</span>
                    </a>
                    <a onclick="navigateTo('etiquetas')" data-view="etiquetas" class="nav-item">
                        <i class="fas fa-tags"></i>
                        <span class="sidebar-text">Etiquetas</span>
                    </a>
                    <a onclick="navigateTo('campanas')" data-view="campanas" class="nav-item">
                        <i class="fas fa-bullhorn"></i>
                        <span class="sidebar-text">Campañas</span>
                    </a>
                    <a onclick="navigateTo('campanas-imagen')" data-view="campanas-imagen" class="nav-item">
                        <i class="fas fa-image"></i>
                        <span class="sidebar-text">Campaña con Imagen</span>
                    </a>
                    <a onclick="navigateTo('mensajes-ads')" data-view="mensajes-ads" class="nav-item">
                        <i class="fas fa-ad"></i>
                        <span class="sidebar-text">Mensajes Ads</span>
                    </a>
                    <a onclick="navigateTo('respuestas-rapidas')" data-view="respuestas-rapidas" class="nav-item">
                        <i class="fas fa-bolt"></i>
                        <span class="sidebar-text">Respuestas rápidas</span>
                    </a>
                    
                    <!-- Menú Desplegable de IA -->
                    <div id="ia-menu">
                        <a onclick="toggleIAMenu()" class="nav-item justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-robot"></i>
                                <span class="sidebar-text">Inteligencia Artificial</span>
                            </div>
                            <i id="ia-menu-chevron" class="fas fa-chevron-down sidebar-text transition-transform"></i>
                        </a>
                        <div id="ia-submenu" class="hidden pl-4">
                            <a onclick="navigateTo('prompts-ia')" data-view="prompts-ia" class="nav-item !py-2">
                                <i class="fas fa-lightbulb w-6"></i>
                                <span class="sidebar-text">Prompts de Anuncios</span>
                            </a>
                            <a onclick="navigateTo('respuestas-ia')" data-view="respuestas-ia" class="nav-item !py-2">
                                <i class="fas fa-book w-6"></i>
                                <span class="sidebar-text">Base de Conocimiento</span>
                            </a>
                            <a onclick="navigateTo('ajustes-ia')" data-view="ajustes-ia" class="nav-item !py-2">
                                <i class="fas fa-cogs w-6"></i>
                                <span class="sidebar-text">Ajustes de IA</span>
                            </a>
                        </div>
                    </div>
                    <!-- Fin Menú IA -->

                    <a onclick="navigateTo('metricas')" data-view="metricas" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span class="sidebar-text">Métricas</span>
                    </a>

                    <a onclick="navigateTo('ajustes')" data-view="ajustes" class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span class="sidebar-text">Ajustes Generales</span>
                    </a>
                </nav>
                <div class="mt-auto">
                     <a id="logout-button" class="nav-item">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="sidebar-text">Cerrar Sesión</span>
                    </a>
                </div>
            </aside>

            <!-- Contenedor donde se renderizan las vistas -->
            <main id="main-view-container"></main>
        </div>
    </div>
    
    <!-- Modales -->
    <div id="image-modal" class="image-modal-backdrop" onclick="closeImageModal()">
        <div class="image-modal-content" onclick="event.stopPropagation()">
            <img id="modal-image-content" src="" alt="Vista ampliada">
            <button class="image-modal-close" onclick="closeImageModal()"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div id="quick-reply-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="quick-reply-modal-title">Añadir Respuesta Rápida</h2>
            <form id="quick-reply-form">
                <input type="hidden" id="qr-doc-id">
                <input type="hidden" id="qr-file-url">
                <input type="hidden" id="qr-file-type">
                <input type="file" id="qr-file-input" accept="image/*,video/*,application/pdf">
                
                <div>
                    <label for="qr-shortcut">Atajo (sin "/")</label>
                    <input type="text" id="qr-shortcut" required class="!mb-4">
                </div>
                <div>
                    <label for="qr-message">Mensaje (opcional si adjuntas archivo)</label>
                    <textarea id="qr-message" rows="4" class="!mb-4"></textarea>
                </div>
                <div>
                    <label for="qr-file-input" class="btn btn-subtle !inline-flex !w-auto">
                        <i class="fas fa-paperclip mr-2"></i> Adjuntar Archivo
                    </label>
                    <div id="qr-media-preview" class="mt-2"></div>
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" onclick="closeQuickReplyModal()" class="btn btn-subtle">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="ad-response-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="ad-response-modal-title">Añadir Mensaje de Anuncio</h2>
            <form id="ad-response-form">
                <input type="hidden" id="ar-doc-id">
                <input type="hidden" id="ar-file-url">
                <input type="hidden" id="ar-file-type">
                <input type="file" id="ar-file-input" accept="image/*,video/*,application/pdf" class="hidden">

                <div>
                    <label for="ar-name">Nombre del Anuncio</label>
                    <input type="text" id="ar-name" required class="!mb-4" placeholder="Ej: Campaña Día de la Madre">
                </div>
                <div>
                    <label for="ar-ad-id">Identificador del Anuncio (Ad ID)</label>
                    <input type="text" id="ar-ad-id" required class="!mb-4" placeholder="Ej: 120229247610060637">
                </div>
                <div>
                    <label for="ar-message">Mensaje de Respuesta (opcional si adjuntas archivo)</label>
                    <textarea id="ar-message" rows="5" class="!mb-4" placeholder="Escribe el mensaje de bienvenida para este anuncio..."></textarea>
                </div>
                 <div>
                    <label>Archivo Adjunto</label>
                    <div id="ar-media-preview" class="mt-2"></div>
                    <label for="ar-file-input" class="btn btn-subtle !inline-flex !w-auto mt-2">
                        <i class="fas fa-paperclip mr-2"></i> <span id="ar-attach-button-text">Adjuntar Archivo</span>
                    </label>
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" onclick="closeAdResponseModal()" class="btn btn-subtle">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="ai-ad-prompt-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="ai-ad-prompt-modal-title">Añadir Prompt de IA</h2>
            <form id="ai-ad-prompt-form">
                <input type="hidden" id="aip-doc-id">
                <div>
                    <label for="aip-name">Nombre del Anuncio</label>
                    <input type="text" id="aip-name" required class="!mb-4" placeholder="Ej: Campaña Verano 2024">
                </div>
                <div>
                    <label for="aip-ad-id">Identificador del Anuncio (Ad ID)</label>
                    <input type="text" id="aip-ad-id" required class="!mb-4" placeholder="Ej: 120229247610060637">
                </div>
                <div>
                    <label for="aip-prompt">Prompt para la IA</label>
                    <textarea id="aip-prompt" rows="6" class="!mb-4" placeholder="Escribe las instrucciones que la IA debe seguir para este anuncio..."></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" onclick="closeAIAdPromptModal()" class="btn btn-subtle">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-contact-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="edit-contact-modal-title">Editar Contacto</h2>
            <form id="edit-contact-form">
                 <input type="hidden" id="edit-contact-id">
                <div>
                    <label for="edit-contact-name">Nombre</label>
                    <input type="text" id="edit-contact-name" required class="!mb-4">
                </div>
                 <div>
                    <label for="edit-contact-nickname">Apodo</label>
                    <input type="text" id="edit-contact-nickname" class="!mb-4">
                </div>
                <div>
                    <label for="edit-contact-email">Correo Electrónico</label>
                    <input type="email" id="edit-contact-email" class="!mb-4">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeEditContactModal()" class="btn btn-subtle">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="tag-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="tag-modal-title">Nueva Etiqueta</h2>
            <form id="tag-form">
                <input type="hidden" id="tag-id">
                <div>
                    <label for="tag-label">Nombre de la Etiqueta</label>
                    <input type="text" id="tag-label" required class="!mb-4">
                </div>
                <div>
                    <label>Color</label>
                    <div class="flex items-center gap-4">
                        <input type="color" id="tag-color-input" value="#3182ce">
                        <label for="tag-color-input" id="tag-color-preview" class="color-picker-label" style="background-color: #3182ce;"></label>
                        <span id="tag-color-hex">#3182ce</span>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeTagModal()" class="btn btn-subtle">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bot-settings-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="bot-settings-modal-title">Ajustes del Bot</h2>
            <form id="bot-settings-form">
                <div>
                    <label for="bot-instructions">Instrucciones para el Bot (Prompt General)</label>
                    <textarea id="bot-instructions" rows="8" class="!mb-4" placeholder="Ej: Eres un asistente virtual amigable y servicial para un CRM de ventas. Tu objetivo es ayudar a cerrar ventas y resolver dudas de los clientes."></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" onclick="closeBotSettingsModal()" class="btn btn-subtle">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Instrucciones</button>
                </div>
            </form>
        </div>
    </div>

    <div id="knowledge-base-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="kb-modal-title">Añadir Respuesta a la Base de Conocimiento</h2>
            <form id="kb-form">
                <input type="hidden" id="kb-doc-id">
                <input type="hidden" id="kb-file-url">
                <input type="hidden" id="kb-file-type">
                <input type="file" id="kb-file-input" accept="image/*,video/*,application/pdf">
                
                <div>
                    <label for="kb-topic">Tema / Palabras Clave</label>
                    <input type="text" id="kb-topic" required class="!mb-4" placeholder="Ej: precio, envío, garantía">
                </div>
                <div>
                    <label for="kb-answer">Respuesta Base (La IA usará esto como guía)</label>
                    <textarea id="kb-answer" rows="4" class="!mb-4" required></textarea>
                </div>
                <div>
                    <label for="kb-file-input" class="btn btn-subtle !inline-flex !w-auto">
                        <i class="fas fa-paperclip mr-2"></i> Adjuntar Archivo (Opcional)
                    </label>
                    <div id="kb-media-preview" class="mt-2"></div>
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" onclick="closeKnowledgeBaseModal()" class="btn btn-subtle">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <!-- Lógica de la Aplicación -->
    <script src="app.js"></script>
    
</body>
</html>
